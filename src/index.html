<html>
<head>
<title>Togetherness Table</title>
<meta charset="utf-8">

<!--
 The SVG viewport is the scrolling / panning / zooming area, so
 prevent touch events from zooming into the page
 ( from https://www.html5rocks.com/en/mobile/touchandmouse/ )
-->
<meta name="viewport" content="width=device-width,user-scalable=no">

<script src="./multiplayer.js"></script><!-- should be imported before togetherjs -->
<script src="https://togetherjs.com/togetherjs-min.js"></script>
<script src="./svg_draggable.js"></script>
<script src="./base32.js"></script>
<script src="./storage.js"></script>
<script src="./svg.js"></script>
<script src="./ui.js"></script>
<script src="./userlog.js"></script>
<script src="./index.js"></script>
<script src="./spatial.js"></script>
<script src="./js/select_box.js"></script>
<script src="./js/svg_dom_json.js"></script>
<script src="./physicsjs-full.js"></script>

<script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.5.1/gsap.js"></script>

<!-- polyfill Promises for Internet Explorer -->
<script src="https://cdn.jsdelivr.net/npm/promise-polyfill@8/dist/polyfill.min.js"></script>

<link rel="stylesheet" type="text/css" href="animate.css">
<link rel="stylesheet" type="text/css" href="index.css">

<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/css/materialize.min.css">
<script src="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/js/materialize.min.js"></script>
<!--
<link rel="stylesheet" href="/lib/materialize/materialize.min.css">
<script src="/lib/materialize/materialize.min.js"></script>
-->
<script src="/lib/pouchdb.js"></script>

<style type="text/css" />
@font-face {
  font-family: SubotypeSteady;
  src: url("subotype_steady.otf") format("opentype");
}
@font-face {
  font-family: UniversalisADFStd-Bold;
  src: url("universalis_adf_std_bold.otf") format("opentype");
}
</style>


</head>

<script>
var table_border_rect
var svg_table
var layer_bg
var layer_mats
var layer_objects
var layer_ui
var viewport
var origViewportSize
var tableRunnerStretchSize
var tableRunnerOffset
var uiButtonObserver


async function initNewTable() {
  let sid = base32.short_id()
  function createLayer(name) {
    layer = svg_table.group()
    layer.attr({
      id: name,
    })
    layer.addClass('layer')
    layer.addClass(name)
    return layer
  }
  let el = document.createElementNS(SVG.ns, 'svg')
  svg_table = SVG.adopt(el)
  svg_table.attr({
    id: 'svg_table' + sid,
    class: 'svg_table',
    width: origViewportSize[0],
    height: origViewportSize[1],
  })

  pattern = svg_table.defs().pattern()
  pattern.attr({
    id: 'bg_pattern' + sid,
    class: 'bg_pattern',
    width: 100,
    height: 100,
    x: 0,
    y: 0,
  })
  pattern_img = pattern.image()
  pattern_img.attr({
    id: 'bg_pattern_image' + sid,
    class: 'bg_pattern_image',
    width: 100,
    height: 100,
    href: 'svg/bg_greentile.svg',
  })

  bgrect = svg_table.rect()
  bgrect.attr({
     id: 'table_bgrect' + sid,
     class: 'table_bgrect',
     x: 0,
     y: 0,
     width: svg_table.width(),
     height: svg_table.height(),
     fill: `url(#${pattern.id()})`,
     stroke: 'none',
  })
  svg_table.add(bgrect)

  let table_runner = await import_foreign_svg('svg/table_runner.svg')
  table_runner.attr({
    width: tableRunnerStretchSize[0],
    height: tableRunnerStretchSize[1],
    x: tableRunnerOffset[0],
    y: tableRunnerOffset[1],
  })
  svg_table.add(table_runner)


  layer_bg = createLayer('layer_bg')
  layer_mats = createLayer('layer_mats')
  layer_objects = createLayer('layer_objects')
  layer_ui = createLayer('layer_ui')
  hookupTable()
  storage.newTable(svg_table.node)
}

async function initPreviousTable(prev_dbid) {
  let el;
  try {
    el = await storage.loadTable(prev_dbid)
  } catch (error) {
    console.warn(`Previous table ${prev_dbid} not found`)
    return initNewTable()
  }
  svg_table = SVG.adopt(el)

  layer_bg = SVG.adopt(el.querySelector('#layer_mats'))
  layer_mats = SVG.adopt(el.querySelector('#layer_mats'))
  layer_objects = SVG.adopt(el.querySelector('#layer_objects'))
  layer_ui = SVG.adopt(el.querySelector('#layer_ui'))
  await load_all_necessary_scripts(el)
  await hookupTable()
}

async function hookupTable() {
  if (viewport.node.querySelector('.svg_table')) {
    viewport.node.removeChild(viewport.node.querySelector('.svg_table'))
  }
  viewport.add(svg_table)
  makeDraggable(viewport)
  multiplayer.initObserver('layer_mats', layer_mats.node)
  multiplayer.initObserver('layer_objects', layer_objects.node)
  multiplayer.initObserver('layer_ui', layer_ui.node)

  uiButtonObserver = new MutationObserver((mutations) => {
    ui.updateButtons()
  })
  uiButtonObserver.observe(layer_ui.node, {
    attributes: true,
    childList: true,
    subtree: true,
  })
}


function becomeTableHost() {
  storage.newTable(svg_table.node)
}

SVG.on(document, 'DOMContentLoaded', async() => {
  storage.setDefaultPreferences()
  storage.init()

  // Override the id-generating function of the svg.js library
  SVG.eid = (name) => {
    return name + '_' + base32.short_id()
  }

  function landscapeOrPortrait() {
    let bodyEl = qs('body')
    if (bodyEl.clientHeight > bodyEl.clientWidth) {
      // 'portrait'
      origViewportSize = [800,1500]
      tableRunnerStretchSize = [1000, 1850]
      tableRunnerOffset= [-100, -180]
    } else {
      // 'landscape'
      origViewportSize = [1200,800]
      tableRunnerStretchSize = [1500, 1100]
      tableRunnerOffset= [-150, -105]
    }
  }
  landscapeOrPortrait()

  viewport = SVG('gamearea')
  viewport.attr({
    id: 'svg_viewport',
    overflow: 'scroll',
    width: qs('body').clientWidth,
    viewBox: `0 0 ${origViewportSize[0]} ${origViewportSize[1]}`,
  })
  viewport.style('overflow', 'scroll')
  viewport.style('background-image', 'url(svg/viewport.svg)')
  viewport.style('background-size', 'cover')

  table_border_rect = viewport.rect()
  table_border_rect.attr({
     x: -1,
     y: -1,
     rx: 0,
     ry: 0,
     width: origViewportSize[0] + 2,
     height: origViewportSize[1] + 2,
     fill: 'none',
     stroke: 'black',
     'stroke-width': 10,
     'stroke-opacity': 0.2,
  })

  if (storage.getPreference('last_table')) {
    await initPreviousTable(storage.getPreference('last_table'))
  } else {
    await initNewTable()
  }

  window.addEventListener("resize", viewportToGameArea)

  // Initialize modals
  instances = M.Modal.init(document.querySelectorAll('.modal'), {
    opacity: 0.75,
  });

  ui.initializeViewport(viewport.node)
  ui.initializeDragSelectBox(viewport.node)

  storage.newViewport(viewport.node.outerHTML)

})

var currentZoom = 1.0;
function zoom(inOrOut) {
  zooms = {
    0.5: { out: 0.5, in: 0.6 },
    0.6: { out: 0.5, in: 0.7 },
    0.7: { out: 0.6, in: 0.8 },
    0.8: { out: 0.7, in: 0.9 },
    0.9: { out: 0.8, in: 1.0 },
    1.0: { out: 0.9, in: 1.25 },
    1.25: { out: 1.0, in: 1.5 },
    1.5: { out: 1.25, in: 1.75 },
    1.75: { out: 1.5, in: 1.75 },
  }
  let oldZoom = currentZoom
  currentZoom = zooms[currentZoom][inOrOut];
  // console.log("c", currentZoom, "o", oldZoom)
  if (oldZoom === currentZoom) {
    return
  }
  let w_prime = parseInt(origViewportSize[0] * currentZoom)
  let h_prime = parseInt(origViewportSize[1] * currentZoom)
  viewport.node.setAttribute('width', w_prime)
  viewport.node.setAttribute('height', h_prime)
  viewport.node.setAttribute(
    'viewBox',
    `0 0 ${svg_table.width()} ${svg_table.height()}`
  )
  viewportToGameArea()
}

function viewportToGameArea() {
  let g = byId('gamearea')
  viewport.width(g.clientWidth)
  viewport.height(g.clientHeight)
}

function downKey(e) {
  // console.log('downkey', e)
  let pressedKey = e.key.toLowerCase()
  if (e.isComposing) { return }
  if (e.altKey || e.shiftKey || e.metaKey || e.ctrlKey) { return }
  if (e.target.selectionStart !== undefined) { // text entry or textarea
    return
  }
  let buttons = document.querySelectorAll('[accessKey=' + pressedKey +']')
  if (buttons.length > 1) {
    console.error('Two buttons have the same accessKey', x.accessKey)
    return
  } else if (buttons.length === 1) {
    buttons[0].click()
  }
}

window.addEventListener('load', () => {
  document.querySelector('body').addEventListener('keydown', downKey)
  load_profile_ui()
  loadPrototypeTokens()
  loadPrototypeDice()
  TogetherJSConfig_getUserColor = function() {
    return storage.getPreference('user_color')
  }
  TogetherJSConfig_getUserName = function() {
    return storage.getPreference('username')
  };
  TogetherJSConfig_findRoom = storage._db.name
})

</script>

<body>

<!-- ============================================================GAMEAREA -->
<!-- ==================================================================== -->
<style>
#topbar {
  width: 100%;
  height: 36px;
  background-color: #000;
  color: #fff;
  text-align: left;
  display: flex;
  flex-flow: row nowrap;
  justify-content: space-between;
}
#topbar h1 {
  font-family: UniversalisADFStd-Bold sans-serif;
  line-height: 36px;
  font-size: 22px;
  margin: 0px 20px;
}
#topbar #header_text {
  color: #ddd;
  line-height: 36px;
  font-size: 16px;
  margin: 0px 20px;
}
#topbar_right {
  margin: 0px 20px;
  overflow: hidden;
}
#gamearea {
  max-width: 100%;
  min-width: 80%;
  min-height: 60%;
  background-color: #efe;
}
@media screen and (max-width: 900px) {
  #gamearea {
    margin-top: 0px;
    max-width: 100vw;
    height: calc(100vh - 10px);
  }
  #topbar h1 {
    font-size: 12px;
  }
}
</style>

<div id="topbar">
  <h1>Togetherness Table</h1>
  <h3 id="header_text">Add dice or cards to the table</h3>
  <div id="topbar_right">
  <a title="Profile" class="modal-trigger" style="cursor: pointer;"
    data-target="dialog_profile"
    data-dialog-id="dialog_profile">
    <svg class="profile_usercolor" fill="#fff" height="36" viewBox="0 0 200 100" >
      <rect x="30" y="5" width="140" height="90" />
      <style>text { font: 26px sans-serif; }</style>
      <text fill="#000a" x="38" y="56" textLength="120" class="profile_username">user</text>
      <text fill="#fff" x="40" y="54" textLength="120" class="profile_username">user</text>
    </svg>
  </a>
  </div>
</div>
  <div id="gamearea"/>
  </div>
<!-- ==================================================================== -->
<!-- ===========================================================/GAMEAREA -->

<!-- =================================================================HUD -->
<div class="hud_overlay" id="hud_overlay_left">
<style>
.hud_overlay {
  z-index: 100;
  pointer-events: none;
}
#hud_overlay_left {
  position: fixed;
  top: 0;
  left: 0;
  bottom: 0;
  height: auto;
  display: flex;
  flex-direction: column;
  justify-content: center;
}

#hud_overlay_right {
  position: fixed;
  top: 0;
  right: 0;
  bottom: 0;
  height: auto;
  display: flex;
  flex-direction: column;
  justify-content: center;
}

.hudmenu {
  pointer-events: auto;
  position: relative;
  background-color: #030303;
}

.hudmenu-left {
  border-top-right-radius: 10px;
  border-bottom-right-radius: 10px;
  display: flex;
  flex-direction: row;
}
.hudmenu-right {
  border-top-left-radius: 10px;
  border-bottom-left-radius: 10px;
  display: flex;
  flex-direction: row-reverse;
}
.hudmenu-left .collapsible {
  max-width: 75px;
  display: flex;
  flex-direction: column;
}
.hudmenu-right .collapsible {
  max-width: 150px;
  display: flex;
  flex-direction: column;
}
.collapsetoggle {
  line-height: 100%;
}
.hudmenu-left .collapsetoggle {
  padding: 5px;
  height: 100%;
  min-width: 10px;
  max-width: 15px;
  border: none;
  border-right: 1px solid rgb(200,200,200,0.5);
}
.hudmenu-right .collapsetoggle {
  padding: 5px;
  height: 100%;
  min-width: 10px;
  max-width: 15px;
  border: none;
  border-left: 1px solid rgb(200,200,200,0.5);
}

.hudmenu-left .collapsetoggle:after {
  content:" ▸";
}
.hudmenu-right .collapsetoggle:after {
  content:" ◂";
}
.collapsed > .collapsible {
  margin: 0px;
}
.hudmenu-left.collapsed > .collapsible {
  max-width: 0px;
}
.hudmenu-right.collapsed > .collapsible {
  max-width: 0px;
}
.hudmenu-bottom.collapsed > .collapsible {
  max-height: 0px;
}

@media only screen and (max-width: 900px) {
  .hudmenu {
    top: auto;
    bottom: 0;
  }
  .hudmenu-right {
    left: auto;
    right: 0;
  }
  #hud_overlay_left {
    justify-content: flex-end;
  }
  #hud_overlay_right {
    justify-content: flex-end;
  }

  .hudmenu-left {
    border-top-right-radius: 10px;
    border-top-left-radius: 10px;
    border-bottom-right-radius: 0px;
    display: flex;
    flex-direction: column-reverse;
  }
  .hudmenu-right {
    border-top-right-radius: 10px;
    border-top-left-radius: 10px;
    border-bottom-left-radius: 0px;
    display: flex;
    flex-direction: column-reverse;
  }
  .hudmenu-left .collapsetoggle {
    height: 20px;
    padding: 5px;
    width: 100%;
    min-width: 75px;
    max-width: auto;
    border: none;
    border-top: 1px solid rgb(200,200,200,0.5);
  }
  .hudmenu-right .collapsetoggle {
    height: 20px;
    padding: 5px;
    width: 100%;
    min-width: 150px;
    max-width: auto;
    border: none;
    border-top: 1px solid rgb(200,200,200,0.5);
  }
  .hudmenu-left .collapsetoggle:after {
    content:" ▲";
  }
  .hudmenu-right .collapsetoggle:after {
    content:" ▲";
  }
  .hudmenu-left.collapsed > .collapsible {
    max-width: auto;
    max-height: 0px;
  }
  .hudmenu-right.collapsed > .collapsible {
    max-width: auto;
    max-height: 0px;
  }
  .hudmenu-bottom.collapsed > .collapsible {
    max-height: 0px;
  }

}

.hudmenu button {
  min-width: 7em;
  min-height: 7em;
  padding: 1em;
  font-size: 8pt;
  border-radius: 10px;
  background-color: #030303;
}

.hudmenu-right button {
}
.hudmenu .btn {
  opacity: 80%;
  color: #f0f0f0;
}
.hudmenu .btn:hover {
  background-color: #000000;
  opacity: 100%;
  color: #ffffff;
}
.hudmenu .btn:focus {
  background-color: #a0a0a0;
}
.hudmenu button[accessKey]::first-letter {
  text-decoration: underline;
}
@media only screen and (max-height: 600px) {
  .hudmenu button {
    min-height: 3em;
  }
}

.collapsegroup > .collapsible {
  overflow: hidden;
  transition: 0.2s ease-out;
  margin: 0px;
  border: none;
}
.collapsetoggle:after {
  content:" ▾";
}
.collapsed > .collapsetoggle:after {
  content:"☰";
}

</style>
<script>
// Do not scroll when swiping around on a menu
window.addEventListener('load', () => {
  document.querySelectorAll('.hudmenu').forEach(el => {
    el.addEventListener('scroll', (evt) => {
      evt.preventDefault()
      evt.stopPropagation()
    })
    el.addEventListener('touchmove', (evt) => {
      evt.preventDefault()
      evt.stopPropagation()
    })
  })
  document.querySelectorAll('.hudmenu .collapsetoggle').forEach(el => {
    el.addEventListener('click', (e) => {
      cgroup = e.target.closest('.collapsegroup')
      cgroup.classList.toggle('active')
      cgroup.classList.toggle('collapsed')
    })
  })
})
</script>
</script>
<section class="hudmenu hudmenu-left collapsegroup" >
  <button class="collapsetoggle" name="toggle_table_buttons"></button>
  <div class="collapsible">

    <button id="quick_die_button" class="btn btn-small"
      onclick="ui.clickQuickButton()"
      title="Clone the selected object"
      >
      <img src="svg/v1/dice_d6.svg"  height="48" />
    </button>

    <div id="dice_button_wrapper">
    <style>
    #dice_button_slide {
      display: none;
    }
    #dice_button_slide td {
      padding: 0px;
    }
    #dice_button_wrapper:hover #dice_button_slide {
      display: inline-block;
      position: absolute;
    }
    </style>
    <button id="dice_dialog_button" class="btn btn-small modal-trigger"
      accesskey="d"
      data-target="dialog_dice"
      data-dialog-id="dialog_dice">
      <img src="img/cubes.svg" height="32" />
      <u>D</u>ice
    </button>
    <div id="dice_button_slide">
        <table><tr>
        <td>
          <button class="btn" id="slide_dice_button_d4"
            onclick="add_object('svg/v1/dice_d4.svg', {
              color: getChosenDiceColor(),
            })"
            >
            <img src="svg/v1/dice_d4.svg" height="48" />
          </button>
        </td>
        <td>
          <button class="btn" id="slide_dice_button_d6"
            onclick="add_object('svg/v1/dice_d6.svg', {
              color: getChosenDiceColor(),
            })"
            >
            <img src="svg/v1/dice_d6.svg" height="48" />
          </button>
        </td>
        <td>
          <button class="btn" id="slide_dice_button_d8"
            onclick="add_object('svg/v1/dice_d8.svg', {
              color: getChosenDiceColor(),
            })"
            >
            <img src="svg/v1/dice_d8.svg" height="48" />
          </button>
        </td>
        <td>
          <button class="btn" id="slide_dice_button_d10"
            onclick="add_object('svg/v1/dice_d10.svg', {
              color: getChosenDiceColor(),
            })"
            >
            <img src="svg/v1/dice_d10.svg" height="48" />
          </button>
        </td>
        <td>
          <button class="btn" id="slide_dice_button_d12"
            onclick="add_object('svg/v1/dice_d12.svg', {
              color: getChosenDiceColor(),
            })"
            >
            <img src="svg/v1/dice_d12.svg" height="48" />
          </button>
        </td>
        <td>
          <button class="btn" id="slide_dice_button_d20"
            onclick="add_object('svg/v1/dice_d20.svg', {
              color: getChosenDiceColor(),
            })"
            >
            <img src="svg/v1/dice_d20.svg" height="48" />
          </button>
        </td>
        </tr></table>
    </div>
    </div>
    <button id="cards_dialog_button" class="btn btn-small modal-trigger"
      accesskey="c"
      data-target="dialog_cards"
      data-dialog-id="dialog_cards">
    <img src="img/poker-hand.svg" height="32" />
    <u>C</u>ards
    </button>
    <button id="tokens_dialog_button" class="btn btn-small modal-trigger"
      accesskey="k"
      data-target="dialog_tokens"
      data-dialog-id="dialog_tokens">
      <img src="img/tokens.svg" height="26" />To<u>k</u>ens
    </button>
    <button id="clocks_dialog_button" class="btn btn-small modal-trigger"
      data-target="dialog_clocks"
      data-dialog-id="dialog_clocks">
      <img src="img/clockwork.svg" height="26" />Clocks
    </button>
    <button id="other_button" class="btn btn-small modal-trigger"
      accesskey="o"
      data-target="dialog_other"
      data-dialog-id="dialog_other">
      <img src="img/jigsaw-box.svg" height="32" />
      <u>O</u>ther
    </button>
    <button id="table_button" class="btn btn-small"
      onclick="ui_popup_dialog_table()"
      accesskey="t"
      >
      <img src="img/table.svg" height="32" />
      <u>T</u>able
    </button>
  </div>

</section>
</div> <!-- end hud_overlay_left -->


<!-- ==================================================================== -->
<div class="hud_overlay" id="hud_overlay_right">
<section class="hudmenu hudmenu-right collapsegroup">
<button class="collapsetoggle btn" name="playermenu"></button>
<div class="collapsible">

  <button id="save_button" class="btn btn-small"
    onclick="ui_popup_dialog_save()"
    data-dialog-id="dialog_save">
    Save
  </button>

  <button id="load_button" class="btn btn-small"
    onclick="ui_popup_dialog_load()"
    data-dialog-id="dialog_load">
    Load
  </button>

  <button id="new_button" class="btn btn-small"
    onclick="initNewTable()"
    >
    New
  </button>

  <button id="activity_button" class="btn btn-small modal-trigger"
    title="Log of game events"
    data-target="dialog_activity_log"
    data-dialog-id="dialog_activity_log">
    Activity Log
  </button>

  <button id="help_button" class="btn btn-small modal-trigger"
    title="Help/About this project"
    data-target="dialog_contribute"
    data-dialog-id="dialog_contribute">
    Help / About
  </button>

  <button class="btn btn-small" onclick="TogetherJS(this); return false;"
    title="Invite / Join Friends"
    id="start-togetherjs"
  ><b style="display: inline-block; line-height: 1.0">Multiplayer
  (Experimental)</b></button>

</div>
</section>
</div> <!-- end hud_overlay_right -->


<!-- ==================================================================== -->

<!-- =============OBJECT ACTIONS ==================== -->
<style>
#hud_overlay_bottom {
  position: fixed;
  bottom: 0px;
  right: 0;
  height: auto;
  display: flex;
  flex-direction: row;
  justify-content: center;
}

.hudmenu-bottom {
  border-top-left-radius: 10px;
  border-top-right-radius: 10px;
}

.hudmenu-bottom .collapsetoggle {
  width: 100%;
  border: none;
  border-top: 1px solid rgb(200,200,200,0.5);
}
button.collapsetoggle {
  min-height: 10px;
  padding: 5px;
}
#object_actions {
  opacity: 80%;
  color: #f0f0f0;
}
#header_text {
  font-size: larger;
  padding: 0px 10px;
}
@media only screen and (max-width: 900px) {
  .hudmenu-bottom .collapsetoggle {
    width: 100vw;
  }
}
</style>
<div class="hud_overlay" id="hud_overlay_bottom">
<div id="object_actions" class="hudmenu hudmenu-bottom collapsegroup">
  <button class="collapsetoggle" name="toggle_object_actions"></button>
  <div class="collapsible">
    <template id="template_object_actions">
      <button class="btn btn-large">Button label</button>
    </template>
  </div>
</div>
</div> <!-- end hud_overlay_bottom -->


<!-- PROFILE  =============================================== PROFILE -->
  <script>
function ui_change_profile(evt) {
  name_input = byId('profile_input_name')
  color_input = byId('profile_input_color')
  if (!name_input.value) {
    return;
  }
  storage.setPreference('username', name_input.value)
  storage.setPreference('user_color', color_input.value)
  load_profile_ui()
  ui.popdown_dialog('dialog_profile')
  multiplayer.net_fire({ type: 'change_profile', data: name_input.value })
}
function load_profile_ui() {
  if (TogetherJS === undefined) {
    return
  }
  name = storage.getPreference('username') || ''
  color = storage.getPreference('user_color')
  if (!name) {
    return
  }
  TogetherJS.refreshUserData()
  TogetherJSConfig_findRoom = storage._db.name
  input = document.querySelector('#profile_input_name')
  input.value = name
  inputs = document.querySelectorAll('#profile_input_color')
  inputs.forEach(input => {
    input.value = color
  })
  document.querySelectorAll('.profile_username').forEach(el => {
    el.textContent = name
  })
  document.querySelectorAll('.profile_usercolor').forEach((el) => {
    el.style.color = color
    if (el.getAttribute('fill')) {
      el.setAttribute('fill', color)
    }
  })
}
  </script>
  <div class="modal" id="dialog_profile">
    <button class="dialog_cancel btn modal-close"
      data-dialog-id="dialog_profile"
    > &#215; </button>
  <div class="modal-content">
    <label for="profile_input_name">Name</label>
    <input id="profile_input_name" type="text" value="" />
    <label for="profile_input_color">Color
    <input id="profile_input_color" type="color" value="#ffffff"
    />
    </label>
    <br />
    <button class="btn" id="dialog_profile_submit"
      onclick="ui_change_profile(this)">
      Update
    </button>
  </div>
  </div>
<!-- /PROFILE ============================================== /PROFILE -->

<!-- SAVE ============================================================ SAVE -->
  <div id="dialog_save" class="modal">
  <script>
function make_safe_svg_string() {
  let elJSON = domJSON.toJSON(
    svg_table.node,
    { domProperties: false }
  )
  let fragment = domJSON.toDOM(elJSON)
  let dd = document.createElement('div')
  dd.appendChild(fragment)
  return dd.innerHTML
}
function download_svg() {
  let svg_string = make_safe_svg_string()
  let blob = new Blob([svg_string], {type: 'image/svg+xml'})
  let tmplink = document.createElement('a')
  tmplink.href = window.URL.createObjectURL(blob)
  let filename = 'tt_' + (new Date().toISOString().substr(0,19)) + '.svg'
  tmplink.download = filename.replace(/[-: ]/g, '_')
  tmplink.click()
}
async function ui_popup_dialog_save() {
  let svg_string = make_safe_svg_string()
  textarea = byId('textarea_save_output')
  textarea.value = svg_string
  ui.popup_dialog({'data-dialog-id': 'dialog_save'})
  let nameEl = byId('local_save_name')
  nameEl.innerHTML = '<progress />'
  await storage.saveTable(svg_table.node)
  nameEl.innerHTML = `<b>${svg_table.node.dataset['dbid']}</b>`
}
  </script>
    <nav class="dialog_nav"  id="save_nav">
    <div class="nav-wrapper">
      <button class="btn dialog_cancel modal-close">
        &#215;
      </button>
      <ul class="left">
        <li><a href="#copy_and_paste">Copy/Paste</a></li>
        <li><a href="#local">Local storage</a></li>
        <li><a href="#cloud">Cloud storage</a></li>
      </ul>
    </div>
    </nav>
  <div class="modal-content">
    <section>
      <a name="copy_and_paste"></a>
      <h1 >Copy and Paste</h1>
      <textarea id="textarea_save_output" cols="82" rows=10>X</textarea>
      <div class="save_explain">
      Copy and paste the contents of this text box to a file on your computer.
      </div>
    </section>
    <section>
      <a name="download"></a>
      <h1 >Download</h1>
      <button class="btn" onclick="download_svg()">Download SVG</button>
      <div class="save_explain">
      Save to your computer.
      </div>
    </section>
    <section>
      <a name="local"></a>
      <h1 >Local storage on your browser</h1>
      <div class="save_explain">
      The table has been saved locally as <span id="local_save_name"></span>
      </div>
    </section>
    <section>
      <a name="cloud"></a>
      <h1 >Cloud storage</h1>
      <div class="save_explain">
      This feature has not been implemented yet. If you would like it to exist,
      <span style="color:teal">tweet</span> "Hey @boardcrafting, please
      make Cloud Storage work on http://1kfa.com/table ! #ttrpg #1kfa
      #featurerequest"
      <b>or</b> start participating with the development on Github
      </div>
    </section>
  </div>
  </div>
<!-- /SAVE ========================================================== /SAVE -->


<!-- LOAD ============================================================ LOAD -->
  <div id="dialog_load" class="modal">
  <script>
async function load_svg() {
  textarea = byId('textarea_load_input')
  let newDoc = new DOMParser().parseFromString(textarea.value, 'image/svg+xml')
  if (newDoc.firstChild.id !== 'svg_table') {
    alert('Save file corrupted!\n(Did you intend to add an SVG doc with the Other menu?)')
    return
  }
  load_new_table(newDoc.firstChild)
  return ui.popdown_dialog('dialog_load')
}
async function show_load_options() {
  optionList = byId('load_options')
  temp = document.querySelector('#load_options > li')
  while(optionList.firstElementChild) {
    // Clear it out - prevent memory leaks
    optionList.firstElementChild.remove()
  }
  let tables = await storage.getAllTables()
  await tables.reverse().map(async(table) => {
    let newLoadOption = temp.cloneNode(true)
    let thumb = await storage.loadThumbnail(table)
    let loadOptionLink = newLoadOption.querySelector('a')
    loadOptionLink.innerText = `${table}`
    loadOptionLink.dataset['tableId'] = table
    loadOptionLink.appendChild(thumb)
    loadOptionLink.addEventListener('click', async (evt) => {
      let tableId = evt.target.dataset['tableId']
      try {
        await initPreviousTable(tableId)
      } catch(error) {
        console.error(error)
        alert('Please report:'+ error)
      }
      return ui.popdown_dialog('dialog_load')
    })
    optionList.appendChild(newLoadOption)
  })
}
async function ui_popup_dialog_load() {
  await show_load_options()
  textarea = byId('textarea_load_input')
  textarea.value = ''
  textarea.innerHTML = ''
  return ui.popup_dialog({'data-dialog-id': 'dialog_load'})
}
  </script>
    <nav class="dialog_nav" id="load_nav">
    <div class="nav-wrapper">
    <button class="dialog_cancel btn modal-close"
      data-dialog-id="dialog_load"
    >
      &#215;
    </button>
      <ul class="left">
        <li><a href="#copy_and_paste">Copy/Paste</a></li>
        <li><a href="#local">Local</a></li>
        <li><a href="#upload">Upload file</a></li>
      </ul>
    </div>
    </nav>
  <div class="modal-content">
    <section>
      <a name="copy_and_paste"></a>
      <h1 class="load_h1">Copy and Paste</h1>
      <textarea id="textarea_load_input" cols="82" rows=5></textarea>
      <div class="load_explain">
      Copy and paste the contents from a previously saved session into this
      text box.
      </div>
      <button class="btn btn-dialog btn-primary" onclick="load_svg()">
      Load
      </button>
    </section>
    <section>
      <a name="local"></a>
      <h1 class="load_h1">Local</h1>
      <div class="load_explain">
      Locally-saved tables:
      <style>
        .local_load_option_template > a {
          margin-bottom: 2px;
          background-color: #ddd;
        }
        .local_load_option_template > a > svg {
          margin-left: 1em;
        }
        .local_load_option_link {
          display: flex;
          flex-flow: row wrap;
          justify-content: flex-start;
          align-items: center;
        }
      </style>
      <ul id="load_options" style="font-family: courier">
        <li class="local_load_option_template">
          <a class="local_load_option_link"></a>
        </li>
      </ul>
      </div>
    </section>
    <section>
      <a name="upload"></a>
      <h1 class="load_h1">Upload file</h1>
      <div class="load_explain">
      This feature has not been implemented yet. If you would like it to exist,
      <span style="color:teal">tweet</span> "Hey @boardcrafting, please make
      file uploading
      work on http://1kfa.com/table ! #ttrpg #1kfa #featurerequest"
      <b>or</b> start participating with the development on Github
      </div>
    </section>
  </div>
  </div>
<!-- /LOAD ========================================================== /LOAD -->


<!-- TABLE  =============================================== TABLE -->
  <script>
function ui_popup_dialog_table() {
  let wInput = byId('table_width_input')
  let hInput = byId('table_height_input')
  wInput.value = svg_table.width()
  hInput.value = svg_table.height()
  return ui.popup_dialog({'data-dialog-id': 'dialog_table'})
}

function ui_change_background() {
  url_input = byId('background_url')
  if (!url_input.value) {
    return;
  }
  let width = byId('background_width').value
  let height = byId('background_height').value
  let image_el = qs('.bg_pattern_image')
  image_el.setAttribute('href', url_input.value);
  image_el.setAttribute('width', width);
  image_el.setAttribute('height', height);
  let pattern_el = qs('.bg_pattern')
  pattern_el.setAttribute('width', width);
  pattern_el.setAttribute('height', height);
  ui.popdown_dialog('dialog_table')
  multiplayer.push_sync()
}

function ui_change_table_size() {
  let wInput = byId('table_width_input')
  let hInput = byId('table_height_input')

  svg_table.width(parseInt(wInput.value))
  svg_table.height(parseInt(hInput.value))
  table_border_rect.width(svg_table.width() + 2)
  table_border_rect.height(svg_table.height() + 2)
  viewport.node.setAttribute(
    'viewBox',
    `0 0 ${svg_table.width()} ${svg_table.height()}`
  )

  ui.popdown_dialog('dialog_table')
  multiplayer.push_sync()
}
function set_bg(url, w, h) {
  byId('background_url').value = url
  byId('background_width').value = w
  byId('background_height').value = h
}
  </script>
  <div class="modal" id="dialog_table">
    <button class="dialog_cancel btn modal-close"
      data-dialog-id="dialog_table"
    >
      &#215;
    </button>
  <div class="modal-content">
    <section>
    <h1>Background</h1>
    Use a URL as a background.  Examples (click to use):
    <ul style="display: flex; flex-flow: row wrap; justify-content: space-evenly;">
      <li><a
        onclick="set_bg('http://www.1kfa.com/table/svg/bg_topography.svg', 600, 600)"
        ><img height="32" src="svg/bg_topography.svg" />
      <li><a
        onclick="set_bg('http://www.1kfa.com/table/svg/bg_hexagons.svg', 28, 49)"
        ><img height="32" src="svg/bg_hexagons.svg" />
      <li><a
        onclick="set_bg('http://www.1kfa.com/table/svg/bg_clouds.svg', 56, 28)"
        ><img height="32" src="svg/bg_clouds.svg" /></a>
      <li><a
        onclick="set_bg('http://www.1kfa.com/table/svg/bg_graphpaper.svg', 100, 100)"
        ><img height="32" src="svg/bg_graphpaper.svg" />
      <li><a
        onclick="set_bg('http://www.1kfa.com/table/svg/bg_winter_sun.svg', 800, 800)"
        ><img height="32" src="svg/bg_winter_sun.svg" />
      <li><a
        onclick="set_bg('http://www.1kfa.com/table/svg/bg_wiggle.svg', 52, 26)"
        ><img height="32" src="svg/bg_wiggle.svg" />
    </ul>
    <fieldset id="table_bg_input_fields">
    <label for="background_url">Enter a URL</label>
    <input id="background_url" type="url"
      value="http://www.1kfa.com/table/svg/bg_topography.svg"
    />
    <label for="background_width">Width</label>
    <input id="background_width" type="number" min="1" value="100" />
    <label for="background_width">Height</label>
    <input id="background_height" type="number" min="1" value="100" />
    </fieldset>
    <button class="btn" id="dialog_bg_submit"
      onclick="ui_change_background()">
      Change Background URL
    </button>
    </section>
    <section>
    <h1>Size</h1>
    <fieldset id="table_size_input_fields">
    <label>
      <span >Width:</span>
      <input id="table_width_input" type="number"
        min="500"
        max="10000"
        value="10"/>
    </label>
    <label>
      <span >Height:</span>
      <input id="table_height_input" type="number"
        min="500"
        max="10000"
        value="10"/>
    </label>
    </fieldset>
    <br />
    <button id="dialog_table_size_submit"
      class="btn"
      onclick="ui_change_table_size()">
      Change Size
    </button>
    </section>
  </div>
  </div>
<!-- /TABLE ============================================== /TABLE -->


<!-- TEXT_INPUT  =============================================== TEXT_INPUT -->

  <div class="modal" id="dialog_text_input">
    <script>

function ui_popup_text_input(el, name, currentVal, eventToFire) {
  let template = byId('popup_text_input_template')
  let inputDiv = template.cloneNode(true)
  template.parentElement.appendChild(inputDiv)
  inputDiv.style.display = 'block'
  inputDiv.id = 'popup_text_input'
  var submitButton = inputDiv.querySelector('#dialog_text_input_submit')

  submitButton.addEventListener('click', (evt) => {
      var target = el
      target.dispatchEvent( new CustomEvent(eventToFire, {
        bubbles: true,
        detail: {
          inputValue: inputDiv.querySelector('#text_input_input').value,
        }
      }))
      inputDiv.remove()
      ui.popdown_dialog('dialog_text_input')
  });

  byId('text_input_label_text').textContent = name
  inputDiv.querySelector('#text_input_input').value = currentVal
  return ui.popup_dialog({'data-dialog-id': 'dialog_text_input'})
}
    </script>
    <button class="dialog_cancel btn modal-close"
      data-dialog-id="dialog_text_input"
    >
      &#215;
    </button>
  <div id="popup_text_input_template" class="modal-content"
    style="display:none"
  >
    <fieldset id="text_input_fields">
    <label id="text_input_label" >
      <span id="text_input_label_text">Enter text:</span>
      <input id="text_input_input" type="text" value="x"/>
    </label>
    </fieldset>
    <br />
    <button id="dialog_text_input_submit">
      Change
    </button>
  </div>
  </div>
<!-- /TEXT_INPUT  ============================================= /TEXT_INPUT -->

<!-- PROPERTIES  =============================================== PROPERTIES -->

  <div class="modal" id="dialog_properties">
    <script>
function ui_popup_button() {
  var allSel = svg_table.select('[data-ui-marked]').members
  if (allSel.length !== 1) {
    alert('You must mark exactly 1 object to edit its properties');
    return
  }
  var el = allSel[0].node.firstChild;
  return ui_popup_properties(el, {'data-dialog-id': 'dialog_properties'})
}

function ui_popup_properties(el, dialog_specifier) {
  var submitButton = byId('dialog_properties_submit')
  var attrs = SVG.adopt(el).attr()

  submitButton.addEventListener('click', (evt) => {
      var target = el

      var inputs = document.getElementsByClassName('properties_input')
      Array.prototype.map.call(inputs, (input) => {
        var name = g(input, 'name')
        if (name) {
          //console.log('setting', target, name, input.value)
          s(target, name, input.value);
        }
      });

      ui.popdown_dialog('dialog_properties')
  });

  fieldset = byId('properties_fields')
  // first, clean up earlier messes
  var to_remove = []
  fieldset.childNodes.forEach((el) => {
    if (!el.classList || !el.classList.contains('template')) {
      to_remove.push(el)
    }
  });
  to_remove.map((el) => { el.remove() });

  inputTemplate = byId('properties_input_template')
  labelTemplate = byId('properties_label_template')
  Object.keys(attrs).map((key) => {
    input = inputTemplate.cloneNode(true)
    label = labelTemplate.cloneNode(false)
    s(label, 'id', 'properties_label_' + key)
    label.innerText = key;
    label.appendChild(input)
    s(input, 'name', key)
    s(input, 'id', 'properties_' + key)
    s(input, 'value', attrs[key])
    if (key.indexOf('data-') !== -1 ) {
      s(input, 'disabled', 'disabled')
    }
    input.classList.add('properties_input')
    input.classList.remove('template')
    label.classList.remove('template')
    fieldset.appendChild(label)
  })
  return ui.popup_dialog(dialog_specifier)
}
    </script>
    <button class="dialog_cancel btn modal-close"
      data-dialog-id="dialog_properties"
    >
      &#215;
    </button>
  <div class="modal-content">
    <fieldset id="properties_fields">
    <label id="properties_label_template" class="template" >
      Template
      <input id="properties_input_template" class="template" type="text" value="x"/>
    </label>
    </fieldset>
    <br />
    <button id="dialog_properties_submit">
      Change
    </button>
  </div>
  </div>
<!-- /PROPERTIES  ============================================= /PROPERTIES -->


<!-- DIALOG_DICE ============================================= DIALOG_DICE -->

  <div class="modal" id="dialog_dice">
  <style>
  @media only screen and (max-width: 900px) {
    .modal table .btn {
      padding: 0px;
    }
  }
  .dice_section {
    margin-bottom: 80px;
  }
  #dialog_dice .dice_input_table .dice_quantity {
    width: 40%;
  }
  </style>
    <script>

function add_dtype(dtype, inputEl, center, serializedState) {
  // console.log("add dtype", dtype, 'state', serializedState)
  num = parseInt(inputEl.value) || 0
  for( var i=0; i < num; i++ ) {
    add_object(
      'svg/v1/dice_' + dtype +'.svg',
      {
        // Wrap 'center' in a new array to avoid async bugs
        'offset': [center[0], center[1]],
        'color': getChosenDiceColor(),
        'serializedState': serializedState,
      },
    )
    center[0] = center[0] + 90
    center[1] = center[1] + 10
  }
  inputEl.value = 0
}

function diceIncrement(dtype) {
  el = byId('dice_input_' + dtype)
  num = parseInt(el.value) || 0
  el.value = num + 1
  return true
}

function ui_submit_dice(section) {
  //console.log('submit', section)
  center = [0, 0]
  if (section === 'sw') {
    dtypes = [
      'sw_setback', 'sw_boost',
      'sw_difficulty', 'sw_ability',
      'sw_challenge', 'sw_proficiency',
      'sw_force'
    ]
    dtypes.forEach((dtype) => {
      add_dtype(dtype, byId('dice_input_' + dtype), center)
    })
  } else if (section === 'fudge') {
    dtypes = ['fudge_d6',]
    dtypes.forEach((dtype) => {
      add_dtype(dtype, byId('dice_input_' + dtype), center)
    })
  } else if (section === 'spiral') {
    dtypes = ['spiral',]
    dtypes.forEach((dtype) => {
      add_dtype(dtype, byId('dice_input_' + dtype), center)
    })
  } else if (section === 'nsided') {
    add_dtype(
      'dn', byId('dice_input_dn'), center,
      document.querySelector('#dn_prototype svg')
    )
  } else if (section === 'user') {
    add_dtype(
      'dsymbol', byId('dice_input_dsymbol'), center,
      {
        faces: byId('dice_input_dsymbol_faces').value
      }
    )
  } else if (section === 'image') {
    add_dtype(
      'dimage', byId('dice_input_dimage'), center,
      {
        urls: byId('dice_input_dimage_urls').value,
        values: byId('dice_input_dimage_values').value,
      }
    )
  } else {
    dtypes = ['d4', 'd6', 'd8', 'd10', 'd0', 'd00', 'd12', 'd20']
    dtypes.forEach((dtype) => {
      add_dtype(dtype, byId('dice_input_' + dtype), center)
    })
  }
  ui.popdown_dialog('dialog_dice')
}

function alterD10Variant(variant='d10') {
  btnEl = document.querySelector('#dice_button_d10')

  imgEl = btnEl.querySelector('img')
  imgEl.setAttribute('src', `svg/v1/dice_${variant}.svg`) // TODO why no work???

  document.querySelector('#dice_input_d10').setAttribute('type', 'hidden')
  document.querySelector('#dice_input_d0').setAttribute('type', 'hidden')
  document.querySelector('#dice_input_d00').setAttribute('type', 'hidden')
  document.querySelector('#d10_variants_tab_d10').removeAttribute('disabled')
  document.querySelector('#d10_variants_tab_d0').removeAttribute('disabled')
  document.querySelector('#d10_variants_tab_d00').removeAttribute('disabled')

  document.querySelector(`#dice_input_${variant}`).setAttribute('type', 'number')
  document.querySelector(`#d10_variants_tab_${variant}`).setAttribute('disabled', 'disabled')
  btnEl.setAttribute('onclick', `diceIncrement('${variant}')`)

}

    </script>
    <nav class="dialog_nav" id="dialog_dice_nav">
    <div class="nav-wrapper">
      <button class="dialog_cancel btn modal-close"
        data-dialog-id="dialog_dice"
      >
        &#215;
      </button>
      <ul class="left">
        <li><a href="#standard">Standard Dice</a></li>
        <li><a href="#sw">SW / Genesys Dice</a></li>
        <li><a href="#fudge">FUDGE Dice</a></li>
        <li><a href="#nsided">N-Sided Dice</a></li>
        <li><a href="#user">User-defined Dice</a></li>
        <li><a href="#image">Image Dice</a></li>
      </ul>
    </div>
    </nav>
  <div class="modal-content">
    <section class="color_section">
      <script>
      function dice_color_change(evt) {
        spec_color = byId('dice_input_color').value;
        radio = document.querySelector('[name=dice_color_radio]:checked')
        spec_color = document.querySelector('#dice_input_color')
        // console.log('here', evt, spec_color, radio)
        spec_color.disabled = (radio.id !== 'dice_color_radio_specify')
        // console.log(spec_color)
      }
      function getChosenDiceColor() {
        radio = document.querySelector('[name=dice_color_radio]:checked')
        spec_color = document.querySelector('#dice_input_color')
        user_color = storage.getPreference('user_color')
        if (radio.id === 'dice_color_radio_specify') {
          return spec_color.value
        } else {
          return user_color
        }
      }
      </script>
      <label for="dice_color_radio_player">
      <input type="radio"
        checked="true"
        onchange="dice_color_change()"
        name="dice_color_radio" id="dice_color_radio_player" />
      <span>Player's Color
      <div>
        <input class="btn-flat"
          id="profile_input_color" type="color" disabled="true" value="#ffffff"/>
      </div>
      </span>
      </label>

      <label for="dice_color_radio_specify">
      <input type="radio"
        onchange="dice_color_change()"
        name="dice_color_radio" id="dice_color_radio_specify" />
      <span>Specify Color
      <div>
        <input class="btn" disabled
          onchange="dice_color_change()"
          id="dice_input_color" type="color" value="#ffffff" />
      </div>
      </span>
      </label>

    </section>
    <section class="dice_section" id="standard_dice_section">
      <a name="standard"></a>
      <h1 id="standard_dice_h1">Standard Dice</h1>
      <!--
      <label for="dice_text_input">Add dice via text specification</label>
      <input id="dice_text_input" type="text" placeholder="1d10, 2d20"/>
      -->
      <table class="dice_input_table"><tr>
      <td>
        <button class="btn" id="dice_button_d4" onclick="diceIncrement('d4')">
          <img src="svg/v1/dice_d4.svg" width="24" height="24" />
        </button>
        &#215;
        <input class="dice_quantity" id="dice_input_d4" type="number" min="0"
          value="0"/>

      </td>
      <td>
        <button class="btn" id="dice_button_d6" onclick="diceIncrement('d6')">
          <img src="svg/v1/dice_d6.svg" width="24" height="24" />
        </button>
        &#215;
        <input id="dice_input_d6" type="number" class="dice_quantity" min="0" value="0"/>
      </td>
      <td>
        <button class="btn" id="dice_button_d8" onclick="diceIncrement('d8')">
          <img src="svg/v1/dice_d8.svg" width="24" height="24" />
        </button>
        &#215;
        <input id="dice_input_d8" type="number" class="dice_quantity" min="0" value="0"/>
      </td>
      <td>
        <button class="btn" id="dice_button_d10" onclick="diceIncrement('d10')">
          <img src="svg/v1/dice_d10.svg" width="24" height="24" />
        </button>
        &#215;
        <input id="dice_input_d10" type="number" class="dice_quantity" min="0" value="0"/>
        <input id="dice_input_d0" type="hidden" class="dice_quantity" min="0" value="0"/>
        <input id="dice_input_d00" type="hidden" class="dice_quantity" min="0" value="0"/>
        <br />
        <style>
        #d10_variants_tabs > .btn-flat {
          font-size: 10px;
          line-height: 10px;
          height: 24px;
          padding-left: 10px;
          padding-right: 10px;
          text-transform: none;
        }
        </style>
        <div id="d10_variants_tabs">
          <button id="d10_variants_tab_d10"
            class="btn btn-flat" onclick="alterD10Variant('d10')" disabled>d10</button>
          <button id="d10_variants_tab_d0"
            class="btn btn-flat" onclick="alterD10Variant('d0')">d0</button>
          <button id="d10_variants_tab_d00"
            class="btn btn-flat" onclick="alterD10Variant('d00')">d00</button>
        </div>
      </td>
      <td>
        <button class="btn" id="dice_button_d12" onclick="diceIncrement('d12')">
          <img src="svg/v1/dice_d12.svg" width="24" height="24" />
        </button>
        &#215;
        <input id="dice_input_d12" type="number" class="dice_quantity" min="0" value="0"/>
      </td>
      <td>
        <button class="btn" id="dice_button_d20" onclick="diceIncrement('d20')">
          <img src="svg/v1/dice_d20.svg" width="24" height="24" />
        </button>
        &#215;
        <input id="dice_input_d20" type="number" class="dice_quantity" min="0" value="0"/>
      </td>
      </tr></table>
      <button id="dialog_submit_standard" onclick="ui_submit_dice('standard')"
        class="btn modal-close">
        Submit
      </button>
    </section>
    <section class="dice_section" id="sw_dice_section">
      <a name="sw"></a>
      <h1 id="sw_dice_h1">SW / Genesys Dice</h1>
      <table class="dice_input_table"><tr>
      <td>
        <button class="btn" id="dice_button_sw_setback" onclick="diceIncrement('sw_setback')">
          <img src="svg/v1/dice_sw_setback.svg" width="24" height="24" />
        </button>
        &#215;
        <input id="dice_input_sw_setback" type="number" class="dice_quantity" min="0" value="0"/>
      </td>
      <td>
        <button class="btn" id="dice_button_sw_boost" onclick="diceIncrement('sw_boost')">
          <img src="svg/v1/dice_sw_boost.svg" width="24" height="24" />
        </button>
        &#215;
        <input id="dice_input_sw_boost" type="number" class="dice_quantity" min="0" value="0"/>
      </td>
      <td>
        <button class="btn" id="dice_button_sw_difficulty" onclick="diceIncrement('sw_difficulty')">
          <img src="svg/v1/dice_sw_difficulty.svg" width="24" height="24" />
        </button>
        &#215;
        <input id="dice_input_sw_difficulty" type="number" class="dice_quantity" min="0" value="0"/>
      </td>
      <td>
        <button class="btn" id="dice_button_sw_ability" onclick="diceIncrement('sw_ability')">
          <img src="svg/v1/dice_sw_ability.svg" width="24" height="24" />
        </button>
        &#215;
        <input id="dice_input_sw_ability" type="number" class="dice_quantity" min="0" value="0"/>
      </td>
      <td>
        <button class="btn" id="dice_button_sw_challenge" onclick="diceIncrement('sw_challenge')">
          <img src="svg/v1/dice_sw_challenge.svg" width="24" height="24" />
        </button>
        &#215;
        <input id="dice_input_sw_challenge" type="number" class="dice_quantity" min="0" value="0"/>
      </td>
      <td>
        <button class="btn" id="dice_button_sw_proficiency" onclick="diceIncrement('sw_proficiency')">
          <img src="svg/v1/dice_sw_proficiency.svg" width="24" height="24" />
        </button>
        &#215;
        <input id="dice_input_sw_proficiency" type="number" class="dice_quantity" min="0" value="0"/>
      </td>
      <td>
        <button class="btn" id="dice_button_sw_force" onclick="diceIncrement('sw_force')">
          <img src="svg/v1/dice_sw_force.svg" width="24" height="24" />
        </button>
        &#215;
        <input id="dice_input_sw_force" type="number" class="dice_quantity" min="0" value="0"/>
      </td>
      </tr></table>
      <button id="dialog_submit_sw" onclick="ui_submit_dice('sw')"
        class="btn modal-close">
        Submit
      </button>
    </section>
    <section class="dice_section" id="fudge_dice_section">
      <a name="fudge"></a>
      <h1 id="fudge_dice_h1">FUDGE (FATE) Dice</h1>
      <table class="dice_input_table"><tr>
      <td>
        <button class="btn" id="dice_button_fudge_d6" onclick="diceIncrement('fudge_d6')">
          <img src="svg/v1/dice_fudge_d6.svg" width="24" height="24" />
        </button>
        &#215;
        <input id="dice_input_fudge_d6" type="number" class="dice_quantity" min="0" value="0"/>
      </td>
      </tr></table>
      <button id="dialog_submit_fudge" onclick="ui_submit_dice('fudge')"
        class="btn modal-close">
        Submit
      </button>
    </section>
    <section class="dice_section" id="spiral_dice_section">
      <a name="spiral"></a>
      <h1 id="spiral_dice_h1"><a href="https://www.spiraldice.com"
      >Spiral Dice</a></h1>
      <table class="dice_input_table"><tr>
      <td>
        <button class="btn" id="dice_button_spiral" onclick="diceIncrement('spiral')">
          <img src="svg/v1/dice_spiral.svg" width="24" height="24" />
        </button>
        &#215;
        <input id="dice_input_spiral" type="number" class="dice_quantity" min="0" value="0"/>
      </td>
      </tr></table>
      <button id="dialog_submit_spiral" onclick="ui_submit_dice('spiral')"
        class="btn modal-close">
        Submit
      </button>
    </section>
    <section class="dice_section" id="nsided_dice_section">
      <a name="nsided"></a>
      <h1 id="nsided_dice_h1">N-Sided Dice</h1>
      <table class="dice_input_table"><tr>
      <td id="dice_cell_dn">

        <script>
function alterFaces(el) {
  // console.log(el.value)
  return make_prototype('svg/v1/dice_dn.svg')
  .then(p => {
    facesTspan = p.querySelector('#tspan_num_faces')
    facesTspan.textContent = 'd' + parseInt(el.value)
    showTspan = p.querySelector('#tspan_numeric_value')
    showTspan.textContent = parseInt(el.value)

    temp = document.querySelector('#dn_prototype')
    while(temp.firstElementChild) {
      // Clear it out - prevent memory leaks
      temp.firstElementChild.remove()
    }
    temp.appendChild(p)

    svg_dn = document.querySelector('#svg_dn')
    svg_dn.style.display = 'block'

    useEl = document.querySelector('#svg_dn use')
    useEl.setAttributeNS(SVG.xlink, 'href', '#' + p.id)
  })
}
function loadPrototypeDice() {
  return alterFaces(document.querySelector('#dice_input_dn_num_faces'))
  .then(() => {
    return alterD10Variant()
  });
}
        </script>

        <label for="dice_input_dn_num_faces">
        How many faces?
        <input
          id="dice_input_dn_num_faces" type="text" value="100" size="3"
          oninput="alterFaces(this)"
          max="999" min="2"
          style="width:auto"
        />
        </label><br />
        N-Sided Dice:
        <button class="btn" id="dice_button_dn" onclick="diceIncrement('dn')">
          <template id="dn_prototype">
          </template>
          <svg style="" id="svg_dn" viewbox="0 0 100 100" width="24" height="24" >
            <use xlink:href="#dice_dn_object" />
          </svg>
        </button>
        &#215;
        <input id="dice_input_dn" type="number" class="dice_quantity" min="0" value="0"/>
      </td>
      </tr>
      </table>
      <button id="dialog_submit_nsided" onclick="ui_submit_dice('nsided')"
        class="btn modal-close">
        Submit
      </button>

    </section>
    <section class="dice_section" id="user_dice_section">

      <a name="user"></a>
      <h1 id="user_dice_h1">User-Defined Dice</h1>
        <style>
        #user_dice_section #dice_input_dsymbol_faces {
          height: 6rem;
          width: 10rem;
          text-align: center;
          word-wrap: normal;
        }
        </style>

      <table class="dice_input_table"><tr>
      <td id="dice_cell_dn">
        <table><tr style="border:none">
        <td>
        <textarea
          id="dice_input_dsymbol_faces"
          name="dice_input_dsymbol_faces"
          rows="6"
          cols="10"
        ></textarea>
        </td>
        <th>
        On each line, enter numbers, letters or emoji. Blank lines will be
        interpreted as empty faces.
        </th>
        </tr></table>

        User-Defined Dice:
        <button class="btn" id="dice_button_dsymbol" onclick="diceIncrement('dsymbol')">
          <img id="img_dice_dsymbol" src="svg/v1/dice_dsymbol.svg" width="24" height="24" />
        </button>
        &#215;
        <input id="dice_input_dsymbol" type="number" class="dice_quantity" min="0" value="0"/>

      </td>
      </tr>
      </table>
      <button id="dialog_submit_user" onclick="ui_submit_dice('user')"
        class="btn modal-close">
        Submit
      </button>

    </section>
    <section class="dice_section" id="image_dice_section">

      <a name="image"></a>
      <h1 id="image_dice_h1">Image Dice</h1>
        <style>
        #image_dice_section #dice_input_dimage_faces {
          height: 6rem;
          width: 10rem;
          text-align: center;
          word-wrap: normal;
        }
        </style>

      <table class="dice_input_table"><tr>
      <td id="dice_cell_dn">
        <table><tr style="border:none">
        <th>
        On each line, enter a URL to an image.
        Blank lines will be interpreted as empty faces.
        </th>
        <th>
        On each line, enter a value (numeric or text) corresponding to the URL.
        Blank lines will be interpreted as 0.
        Values entered will work with the Dynamic Trays.
        </th>
        </tr>
        <tr>
        <td>
        <textarea
          id="dice_input_dimage_urls"
          name="dice_input_dimage_urls"
          rows="8"
          cols="50"
        >https://www.1kfa.com/table/img/pips1.png
https://www.1kfa.com/table/img/pips2.png
https://www.1kfa.com/table/img/pips3.png
https://www.1kfa.com/table/img/pips4.png
https://www.1kfa.com/table/img/pips5.png
https://www.1kfa.com/table/img/pips6.png</textarea>
        </td>
        <td>
        <textarea
          id="dice_input_dimage_values"
          name="dice_input_dimage_values"
          rows="8"
          cols="10"
        >
        1
        2
        3
        4
        5
        6
        </textarea>
        </td>
        <th>
        </tr></table>

        Image Dice:
        <button class="btn" id="dice_button_dimage" onclick="diceIncrement('dimage')">
          <img id="img_dice_dimage" src="svg/v1/dice_dimage.svg" width="24" height="24" />
        </button>
        &#215;
        <input id="dice_input_dimage" type="number" class="dice_quantity" min="0" value="0"/>

      </td>
      </tr>
      </table>
      <button id="dialog_submit_image" onclick="ui_submit_dice('image')"
        class="btn modal-close">
        Submit
      </button>
    </section>
  </div>
  </div>

<!-- END DIALOG_DICE ====================================== END DIALOG_DICE -->


<!-- SVGFILE =========================================================== SVGFILE -->

  <div class="modal" id="dialog_svgfile">
    <script>

function ui_submit_svgfile(evt) {
  textarea = byId('svgfile_body')

  allowJS = byId('dialog_svgfile').querySelector(
    'input[name=allow_javascript]:checked'
  )
  if (allowJS.value !== 'yes') {
    newDoc = new DOMParser().parseFromString(textarea.value, 'image/svg+xml')
    defanged = domJSON.toJSON(newDoc.firstChild)
    newDoc = domJSON.toDOM(defanged)
    body = newDoc.firstChild.outerHTML
  } else {
    body = textarea.value
  }

  _import_foreign_svg(body)
  .then(nest => {
    add_to_layer_objects(nest, {})
    ui.popdown_dialog('dialog_svgfile')
  })
}

    </script>
    <button class="dialog_cancel btn modal-close"
      data-dialog-id="dialog_svgfile"
    >
      &#215;
    </button>
  <div class="modal-content">
      <p><b>What is an SVG?</b>
        Fundamentally, an SVG is just a simple text file that tells the
        computer how to draw an image using shapes, the same way HTML is
        just a text file that tells the computer how to render a web page.
        <a href="https://www.w3schools.com/graphics/svg_intro.asp">Find out
        more here.</a>
      </p>
      <p>
        You can create your drawings with Free programs like
        <a href="https">Inkscape</a>
        or websites like
        <a href="https://svg-edit.github.io/svgedit/editor/svg-editor.html">SVGEdit</a>
      </p>
      <label>
      <input name="allow_javascript" type="radio" checked value="yes" />
      <span>Allow JavaScript (JavaScript not usable by others in multiplayer)</span>
      </label>
      <br />
      <label>
      <input name="allow_javascript" type="radio" value="no" />
      <span>Safety mode</span>
      </label>
      <p>
    <textarea id="svgfile_body"
      cols="82" style="font-family:monospace"
      onLoad="textareaFit(this)"
      onInput="textareaFit(this)"></textarea>
<script>
function textareaFit(e) {
  // console.log(e)
  const tx = document.querySelector('#svgfile_body')
  tx.style.height = 'auto'
  tx.style.height = Math.max(40, Math.min(200, tx.scrollHeight))
}
</script>
    <div class="load_explain">
    Copy and paste the contents from an SVG file into this
    text box.
    </div>
    <br />
    <button id="dialog_submit" onclick="ui_submit_svgfile(this)"
      class="btn modal-close">
      Create
    </button>
    <p>
    <i>Note:</i> Some great SVG files can be found at <a
      href="https://game-icons.net" target="_">game-icons.net</a> and <a
      href="https://thenounproject.com" target="_">Noun Project</a>.
  <hr />
  <section>
  <h3>Examples:</h3>
  <p>Try pasting this into the box:</p>
  <pre>
&lt;svg xmlns="http://www.w3.org/2000/svg"
  x="0" y="0" width="100" height="100"&gt;
  &lt;rect x="25" y="25" width="50" height="50" style="fill:#ff0000" /&gt;
  &lt;script
    type="text/javascript"
    data-namespace="myThing"
  &gt;&lt;![CDATA[

myThing = {

  menu: {
    'Change Color': {
      eventName: 'changeMyColor',
      applicable: (elem) =&gt; { return true },
      uiLabel: (elem) =&gt; { return 'Change Color To Green' },
      handler: function(evt) {
        // Note - "handler" must be written as a traditional function,
        // not an arrow-function, so that "this" is bound correctly
        // console.log('Changing color!')
        this.querySelector('rect').style['fill'] = '#00ff00'
      },
    },
  },

}

]]&gt;&lt;/script&gt;
&lt;/svg&gt;
  </pre>
  </section>
  </div>
  </div>

<!-- END SVGFILE =================================================== END SVGFILE -->


<!-- RECT =========================================================== RECT -->

  <div class="modal" id="dialog_rect">
    <script>


function make_rect(attrs) {
  var rect = layer_objects.rect()
  let sid = base32.short_id()
  rect.attr(Object.assign({
    'data-app-url': '#rect_' + sid,
    id: 'rect_' + sid,
    rx: 0,
    ry: 0,
    x: 0.5,
    y: 0.5,
    width: 100,
    height: 50,
    fill: '#fff59d',
    stroke: 'black',
    'fill-opacity': 0.9,
    'stroke-opacity': 0.9,
    'stroke-width': 1,
  }, attrs))

  var nest = layer_objects.element('svg', SVG.Container)
  //nest.attr(Object.assign({
  nest.attr({
    'data-app-url': '#nest',
    'id': 'o_' + rect.attr('id'), // special ID
    'width': rect.width() + 1,
    'height': rect.width() + 1,
  })
  //}, attrs))
  nest.addClass('draggable-group')
  nest.addClass('o_rect')

  nest.add(rect)
  return nest;
}

function ui_submit_rect(evt) {
  w = parseInt(byId('rect_input_width').value);
  h = parseInt(byId('rect_input_height').value);
  color = byId('rect_input_color').value;
  if (!w || !h || !color ) {
    return;
  }
  var nest = make_rect({
    width: w,
    height: h,
    fill: color,
  });
  add_to_layer_objects(nest)
  ui.popdown_dialog('dialog_rect')
}

    </script>
    <button class="dialog_cancel btn modal-close"
      data-dialog-id="dialog_rect"
    >
      &#215;
    </button>
  <div class="modal-content">
    <label for="rect_input_width">Width</label>
    <input id="rect_input_width" type="text" value="100"/>
    <br />
    <label for="rect_input_height">Height</label>
    <input id="rect_input_height" type="text" value="50"/>
    <br />
    <label for="rect_input_color">Color
    <input id="rect_input_color" type="color" value="#ff9000" />
    </label>
    <br />
    <button id="dialog_submit" onclick="ui_submit_rect(this)"
      class="btn modal-close">
      Create
    </button>
  </div>
  </div>

<!-- END RECT =================================================== END RECT -->

<!-- IMAGE =========================================================== IMAGE -->
  <div class="modal" id="dialog_image">
    <script>
function image_object_add() {
  let serializedState = qs('#svg_image_object')
  add_object( 'svg/v1/image_object.svg',
    {
      'serializedState': serializedState,
    },
  )
  ui.popdown_dialog('dialog_image')
}
function updateImagePrototype(target) {
  el = qs('#svg_image_object .internal_image')
  el.setAttribute('href', target.value)
}
  </script>
    <button class="dialog_cancel btn modal-close"
      data-dialog-id="dialog_image"
    >
      &#215;
    </button>
  <div class="modal-content">
    <label>
      <div style="display: inline-block" id="button_image_object">
          <svg id="svg_image_object" viewbox="0 0 100 100" width="24" height="24" >
            <image href="img/image.png" width="100" height="100"
              class="internal_image"
            />
          </svg>
      </div>
      Image URL
    <input
        id="input_image_url" type="text"
        placeholder="https://www.1kfa.com/table/img/image.png"
        pattern="http.*"
        onInput="updateImagePrototype(this)"
    />
    </label>
    <br />
    <button id="dialog_submit" onclick="image_object_add()"
      class="btn modal-close">
      Create
    </button>
    <br />
    <i>Note:</i> Some great images can be found on <a
      href="https://en.wikipedia.org/wiki/Wikipedia:Featured_pictures">Wikipedia</a>
    <br />
    Once added to the table, images can be <b>resized by double-clicking</b>.
  </div>
  </div>
<!-- END IMAGE =================================================== END IMAGE -->


<!-- TEXT =========================================================== TEXT -->

  <div class="modal" id="dialog_text">
    <script>

function make_text(content, color, bgcolor) {
  var padding = 8
  var text = layer_objects.plain('')
  var tspan = text.tspan(content)
  let sid = base32.short_id()
  text.attr({
    'data-app-url': '#text_' + sid,
    id: 'text_' + sid,
    fill: color ? color : '#000000',
    x: 0,
    y: 0,
    'stroke-opacity': 0,
    'font-weight': 'normal',
    'font-size': '12pt',
  })
  var bbox = text.bbox()
  text.y(padding/2)
  text.x(padding/2)

  var rect = layer_objects.rect()
  rect.attr({
    id: 'rect_' + text.attr('id'), // special ID
    rx: 5,
    ry: 5,
    fill: bgcolor ? bgcolor : '#ffffff',
    'fill-opacity': 0.5,
    'stroke-opacity': 0,
    width: bbox.width + padding,
    height: bbox.height + padding,
  })
  rect.addClass('text-rect')

  var nest = layer_objects.element('svg', SVG.Container)
  nest.attr({
    'data-app-url': '#nest',
    'id': 'o_' + text.attr('id'), // special ID
    x: 0,
    y: 0,
    width: rect.width(),
    height: rect.height() * 2,
  })
  nest.addClass('draggable-group')
  nest.addClass('o_text')

  rect.y(rect.y() + (rect.height()/2))
  nest.add(rect)
  text.y(text.y() + (rect.height()/2))
  nest.add(text)

  return nest;
}

function ui_submit_text(evt) {
  let c = byId('text_input_content').value;
  let color = byId('text_input_color').value;
  let bgcolor = byId('text_input_bgcolor').value;
  if (!c || !color ) {
    return;
  }
  var nest = make_text(c, color, bgcolor)
  add_to_layer_objects(nest)
  ui.popdown_dialog('dialog_text')
}

    </script>
    <button class="dialog_cancel btn modal-close"
      data-dialog-id="dialog_text"
    >
      &#215;
    </button>
  <div class="modal-content">
    <label for="text_input_content">Content</label>
    <input id="text_input_content" type="text" value="" Placeholder="Hello World"/>
    <br />
    <label for="text_input_color">Color
    <input id="text_input_color" type="color" value="#000080"
    />
    </label>
    <br />
    <label for="text_input_bgcolor">Background Color
    <input id="text_input_bgcolor" type="color" value="#ffffff"
    />
    </label>
    <br />
    <button id="dialog_submit" onclick="ui_submit_text(this)"
      class="btn modal-close">
      Create
    </button>
  </div>
  </div>

<!-- END TEXT =================================================== END TEXT -->


<!-- CIRCLE ========================================================CIRCLE -->

  <div class="modal" id="dialog_ellipse">
    <script>

function make_ellipse(attrs) {
  let ellipse = layer_objects.ellipse()
  let sid = base32.short_id()
  ellipse.attr(Object.assign({
    'data-app-url': '#ellipse_' + sid,
    id: 'ellipse_' + sid,
    rx: 100,
    ry: 50,
    cx: 50,
    cy: 50,
    fill: '#fff59d',
    stroke: 'black',
    'fill-opacity': 0.9,
    'stroke-opacity': 0.9,
    'stroke-width': 1,
  }, attrs))
  ellipse.x(ellipse.x() + 1)
  ellipse.y(ellipse.y() + 1)

  var nest = layer_objects.element('svg', SVG.Container)
  nest.attr(Object.assign({
    'data-app-url': '#nest_' + sid,
    'id': 'o_' + ellipse.attr('id'), // special ID
    'width': ellipse.width() + 2,
    'height': ellipse.height() + 2,
  }, attrs))
  nest.addClass('draggable-group')
  nest.addClass('o_ellipse')

  nest.add(ellipse)

  return nest;
}

function ui_submit_ellipse(evt) {
  w = parseInt(byId('ellipse_input_width').value);
  h = parseInt(byId('ellipse_input_height').value);
  color = byId('ellipse_input_color').value;
  if (!w || !h || !color ) {
    return
  }
  var nest = make_ellipse({
    rx: w / 2,
    ry: h / 2,
    cx: w / 2,
    cy: h / 2,
    fill: color,
  })
  add_to_layer_objects(nest)
  ui.popdown_dialog('dialog_ellipse')
}

    </script>
    <button class="dialog_cancel btn modal-close"
      data-dialog-id="dialog_ellipse"
    >
      &#215;
    </button>
  <div class="modal-content">
    <label for="ellipse_input_width">Width</label>
    <input id="ellipse_input_width" type="text" value="100"/>
    <br />
    <label for="ellipse_input_height">Height</label>
    <input id="ellipse_input_height" type="text" value="50"/>
    <br />
    <label for="ellipse_input_color">Color
    <input id="ellipse_input_color" type="color" value="#ff9000"
    />
    </label>
    <br />
    <button id="dialog_submit" onclick="ui_submit_ellipse(this)"
      class="btn modal-close">
      Create
    </button>
  </div>
  </div>

<!-- END CIRCLE =============================================== END CIRCLE -->


<!-- OTHER ======================================================= OTHER -->

  <div class="modal" id="dialog_other">
  <style>
#dialog_other section button {
  min-width: 7em;
  min-height: 7em;
  padding: 1em;
  font-size: 8pt;
  border-radius: 10px;
  background-color: #030303;
}

#dialog_other section .btn {
  opacity: 80%;
  color: #f0f0f0;
}
#dialog_other section .btn:hover {
  background-color: #000000;
  opacity: 100%;
  color: #ffffff;
}
@media only screen and (max-height: 600px) {
  #dialog_other section  button {
    min-height: 3em;
  }
}
</style>
    <button class="dialog_cancel btn modal-close" data-dialog-id="dialog_other"
    > &#215; </button>
    <nav class="dialog_nav">
    <div class="nav-wrapper">
      <ul class="left">
        <li><a href="#drawing">Drawing</a></li>
        <li><a href="#dynamic_tray">Dynamic Tray</a></li>
        <li><a href="#mats">Mats</a></li>
      </ul>
    </div>
    </nav>
    <div class="modal-content">
    <section id="drawing_section">
      <a name="drawing"></a>
      <h1 id="drawing_h1">Drawing</h1>
      <button id="svgfile_button" class="btn btn-small modal-trigger modal-close"
        data-target="dialog_svgfile"
        data-dialog-id="dialog_svgfile">
        <img src="img/svgfile.svg" height="26" />SVG File
      </button>
      <button id="rect_button" class="btn btn-small modal-trigger modal-close"
        data-target="dialog_rect"
        data-dialog-id="dialog_rect">
        <img src="img/rect.svg" height="26" />Rectangle
      </button>
      <button id="ellipse_button" class="btn btn-small modal-trigger modal-close"
        data-target="dialog_ellipse"
        data-dialog-id="dialog_ellipse">
        <img src="img/ellipse.svg" height="26" />Circle
      </button>
      <button id="text_button" class="btn btn-small modal-trigger modal-close"
        data-target="dialog_text"
        data-dialog-id="dialog_text">
        <img src="img/text.svg" height="26" />Text
      </button>
      <button id="image_button" class="btn btn-small modal-trigger modal-close"
        data-target="dialog_image"
        data-dialog-id="dialog_image">
        <img src="img/image.svg" height="26" />Image
      </button>
      <!--
      <button id="random_table_button" class="btn btn-small modal-trigger modal-close"
        data-target="dialog_random_table"
        data-dialog-id="dialog_random_table">
        + Random Table
      </button>
      -->
    </section>
    <section id="dynamic_tray_section">
      <a name="dynamic_tray"></a>
      <h1 id="dynamic_tray_h1">Dynamic Tray</h1>
      <p>
      Dynamic Trays will automatically do calculations based on
      the dice (or other objects like text) placed inside them
      </p>
      <button class="btn btn-small modal-close"
        onclick="add_object('svg/v1/tray_sum.svg')">
        Sum
      </button>
      <button class="btn btn-small modal-close"
        onclick="add_object('svg/v1/tray_count.svg')">
        Count
      </button>
      <button class="btn btn-small modal-close"
        onclick="add_object('svg/v1/tray_modifier.svg')">
        Modifier
      </button>
      <button class="btn btn-small modal-close"
        onclick="add_object('svg/v1/tray_best.svg')">
        Best-of
      </button>
      <button class="btn btn-small modal-close"
        onclick="add_object('svg/v1/tray_sorter.svg')">
        Sorter
      </button>
      <button class="btn btn-small modal-close"
        onclick="add_object('svg/v1/tray_tabulate.svg')">
        Tabulate
      </button>
      <button class="btn btn-small modal-close"
        onclick="add_object('svg/v1/tray_explode.svg')">
        Explode
      </button>
      <button class="btn btn-small modal-close"
        onclick="add_object('svg/v1/tray_median.svg')">
        Median
      </button>
      <button class="btn btn-small modal-close"
        onclick="add_object('svg/v1/tray_genesys.svg')">
        Genesys
      </button>
    </section>
    <section id="mats_section">
      <a name="mats"></a>
      <h1 id="mats_h1">Mats</h1>
      <p>
      Mats go beneath other objects and have snap-to behaviour
      </p>
      <button class="btn btn-small modal-close"
        onclick="add_mat('svg/v1/mat_gridpaper.svg')">
        Grid Paper
      </button>
      <button class="btn btn-small modal-close"
        onclick="add_mat('svg/v1/mat_chessboard.svg')">
        Chessboard
      </button>
    </section>
    </div>
  </div>

<!-- END OTHER =============================================== END OTHER -->

<!-- CARDS ======================================================= CARDS -->

  <div class="modal" id="dialog_cards">
  <script>
function ui_submit_card() {
  inputEl = byId('card_input_card_code')
  if (!inputEl.checkValidity()) {
    return
  }
  card_code = inputEl.value
  add_object('svg/v1/single_poker_card.svg',
    { 'serializedState': card_code },
  )
  inputEl.value = ''
  ui.popdown_dialog('dialog_cards')
}
  </script>
    <button class="dialog_cancel btn modal-close" data-dialog-id="dialog_cards"
    > &#215; </button>
    <div class="modal-content">
    <section id="decks_section">
      <a name="decks"></a>
      <h1 class="decks_h1">Decks</h1>
      <button class="btn btn-small modal-close"
        onclick="add_object('svg/v1/poker_deck_mobile.svg')">
        + Poker Deck
      </button>
      <button class="btn btn-small modal-close"
        onclick="add_object('svg/v1/tarot_deck.svg')">
        + Tarot Deck
      </button>
      <button class="btn btn-small modal-close"
        onclick="add_object('svg/v1/deckahedron_deck.svg')">
        + Deckahedron
      </button>
    </section>
    <section id="cards_section">
      <a name="single"></a>
      <h1 class="single_h1">Single poker card</h1>
      <style>
      #card_input_card_code:invalid {
        border: solid red;
      }
      </style>
      <label>
        Enter card "code", or blank for a random card.
        Each card is new and not from a deck, so repeats may happen.
      <input
          id="card_input_card_code" type="text" placeholder="3h" size="3"
          title="A rank-suit card code. Like 'Ac' for the Ace of Clubs"
          pattern="1?[0-9ajqkAJQK][hcdsHCDS]"
      />
      </label>
      <button id="dialog_submit_single_card" onclick="ui_submit_card()"
        class="btn">
        + Card
      </button>
    </section>
    </div>
  </div>

<!-- END CARDS =============================================== END CARDS -->

<!-- CLOCKS ======================================================= CLOCKS -->

  <div class="modal" id="dialog_clocks">
    <button class="dialog_cancel btn modal-close" data-dialog-id="dialog_clocks"
    > &#215; </button>
    <div class="modal-content">
    <section id="clocks_section">
      <button class="btn btn-small modal-close"
        onclick="add_object('svg/v1/clock_4.svg')">
        + 4-Clock
      </button>
      <button class="btn btn-small modal-close"
        onclick="add_object('svg/v1/clock_6.svg')">
        + 6-Clock
      </button>
      <button class="btn btn-small modal-close"
        onclick="add_object('svg/v1/clock_8.svg')">
        + 8-Clock
      </button>
      <button class="btn btn-small modal-close"
        onclick="add_object('svg/v1/clock_10.svg')">
        + 10-Clock
      </button>
      <button class="btn btn-small modal-close"
        onclick="add_object('svg/v1/clock_12.svg')">
        + 12-Clock
      </button>
    </section>
    </div>
  </div>

<!-- END CLOCKS =============================================== END CLOCKS -->

<!-- TOKENS ======================================================= TOKENS -->

  <div class="modal" id="dialog_tokens">
    <style>
#dialog_tokens section .tokens_quantity {
  width: 50%;
}
.frontback_table tr *:nth-child(2) {
  background-color: #f0f0f0;
}
.frontback_table td {
  max-width: 40em;
}
    </style>
    <script>
function resetPrototypeButton(buttonEl, proto) {
  temp = buttonEl.querySelector(`#${buttonEl.id} > template`)
  while(temp.firstElementChild) {
    // Clear it out - prevent memory leaks
    temp.firstElementChild.remove()
  }
  temp.appendChild(proto)
  useEl = buttonEl.querySelector(`#${buttonEl.id} > svg use`)
  useEl.setAttribute('href', '#' + proto.id)
}
function alterSolidColorToken() {
  return make_prototype('svg/v1/token_solidcolor.svg')
  .then(p => {
    frontColor = document.querySelector('#token_solidcolor_input_color_front').value
    backColor = document.querySelector('#token_solidcolor_input_color_back').value
    frontEl = SVG.adopt(p.querySelector('#token_front'))
    frontEl.fill(frontColor)
    backEl = SVG.adopt(p.querySelector('#token_back'))
    backEl.fill(backColor)

    buttonEl = document.querySelector('#token_solidcolor_button')
    resetPrototypeButton(buttonEl, p)
  })
}
function alterImageToken() {
  return make_prototype('svg/v1/token_image.svg')
  .then(p => {
    frontUrl = document.querySelector('#token_image_input_front').value
    backUrl = document.querySelector('#token_image_input_back').value
    frontExampleEl = document.querySelector('#token_image_example_front')
    backExampleEl = document.querySelector('#token_image_example_back')
    frontEl = p.querySelector('#token_front')
    backEl = p.querySelector('#token_back')
    frontEl.setAttribute('href', frontUrl)
    backEl.setAttribute('href', backUrl)
    frontExampleEl.setAttribute('src', frontUrl)
    backExampleEl.setAttribute('src', backUrl)

    buttonEl = document.querySelector('#token_image_button')
    resetPrototypeButton(buttonEl, p)
  })
}
function alterCustomSVGToken() {
  return make_prototype('svg/v1/token_customsvg.svg')
  .then(p => {
    buttonEl = document.querySelector('#token_customsvg_button')
    placeholderEl = SVG.adopt(buttonEl.querySelector(`#${buttonEl.id} > svg`))

    frontData = document.querySelector('#token_customsvg_input_front').value
    placeholderEl.svg('<g>' + frontData + '</g>')
    newFrontGroup = placeholderEl.node.lastElementChild
    newFrontGroup.remove()
    // console.log('nfg', newFrontGroup)
    front_g = SVG.adopt(p.querySelector('#token_front'))
    // console.log('removing', front_g.node.lastElementChild)
    front_g.node.lastElementChild.remove()
    front_g.node.appendChild(newFrontGroup)

    backData = document.querySelector('#token_customsvg_input_back').value
    placeholderEl.svg('<g>' + backData + '</g>')
    newBackGroup = placeholderEl.node.lastElementChild
    newBackGroup.remove()
    // console.log('nbg', newBackGroup)
    backSVG = SVG.adopt(p.querySelector('#token_back'))
    // console.log('removing', backSVG.node.lastElementChild)
    backSVG.node.lastElementChild.remove()
    backSVG.node.appendChild(newBackGroup)

    resetPrototypeButton(buttonEl, p)
  })
}
function loadPrototypeTokens() {
  alterSolidColorToken()
  alterImageToken()
  alterCustomSVGToken()
}
function token_add(buttonEl) {
  //console.log('buttonEl is', buttonEl)
  let serializedState = buttonEl.querySelector('template svg')
  let quantityEl = buttonEl.parentNode.querySelector('.tokens_quantity')
  let num = parseInt(quantityEl.value) || 1
  let center = [0,0]
  //console.log('adding ', num, 'tokens')
  for( var i=0; i < num; i++ ) {
    add_object(
      serializedState.dataset.appUrl,
      {
        // Wrap 'center' in a new array to avoid async bugs
        'offset': [center[0], center[1]],
        'serializedState': serializedState,
      },
    )
    center[0] = center[0] + 90
    center[1] = center[1] + 10
  }
  quantityEl.value = 1
}
    </script>
    <button class="dialog_cancel btn modal-close" data-dialog-id="dialog_tokens"
    > &#215; </button>
    <nav class="dialog_nav">
    <div class="nav-wrapper">
      <ul class="left">
        <li><a href="#solidcolor">Solid Color</a></li>
        <li><a href="#imagetoken">Image Token</a></li>
        <li><a href="#customsvg">Custom SVG</a></li>
      </ul>
    </div>
    </nav>
    <div class="modal-content">

    <section id="tokens_solidcolor_section">
      <a name="solidcolor"></a>
      <h1 id="solidcolor_h1">Solid color</h1>
      <table id="token_solidcolor_table" class="frontback_table"><tr>
        <th>
          <label for="token_solidcolor_input_color_front">
          Front
          </label>
        </th>
        <th>
          <label for="token_solidcolor_input_color_back">
          Back
          </label>
        </th>
        </tr><tr>
        <td>
          <input id="token_solidcolor_input_color_front" type="color" value="#ffff00"
            onchange="alterSolidColorToken(this)"
          />
        </td>
        <td>
          <input id="token_solidcolor_input_color_back" type="color" value="#ff0000"
            onchange="alterSolidColorToken(this)"
          />
        </td>
      </tr></table>
      <input id="token_solidcolor_input_quantity" class="tokens_quantity"
        type="number" min="1" max=30" value="1"/>
      <button id="token_solidcolor_button" class="btn modal-close"
        onclick="token_add(this)">
        <template id="token_solidcolor_prototype">
        </template>
        <svg style="display:inline-block;" id="svg_token_solidcolor"
          viewbox="0 0 80 90" width="24" height="24" >
          <use xlink:href="#token_solidcolor_object" />
        </svg>
        Create
      </button>
    </section>

    <section id="tokens_imagetoken_section">
      <a name="imagetoken"></a>
      <h1 id="imagetoken_h1">Image token</h1>
      <i>Note:</i> Some great images can be found on <a href="https://en.wikipedia.org/wiki/Wikipedia:Featured_pictures">Wikipedia</a>
      <table id="token_image_table" class="frontback_table"><tr>
        <th>
          <label for="token_image_input_front">
          Front
          </label>
        </th>
        <th>
          <label for="token_image_input_back">
          Back
          </label>
        </th>
        </tr><tr>
        <td>
          <img id="token_image_example_front"
          width="50" height="50" src="img/image.png" />
          <input id="token_image_input_front" type="url"
            value="img/image.png"
            onchange="alterImageToken(this)"
          />
        </td>
        <td>
          <img id="token_image_example_back"
          width="50" height="50" src="img/image.png" />
          <input id="token_image_input_back" type="url"
            value="img/image.png"
            onchange="alterImageToken(this)"
          />
        </td>
      </tr></table>
      <input id="token_image_input_quantity" class="tokens_quantity"
        type="number" min="1" max=30" value="1"/>
      <button id="token_image_button" class="btn modal-close"
        onclick="token_add(this)">
        <template id="token_image_prototype">
        </template>
        <svg style="display:inline-block;" id="svg_token_image"
          viewbox="0 0 80 90" width="24" height="24" >
          <use xlink:href="#token_image_object" />
        </svg>
        Create
      </button>
    </section>

    <section id="tokens_customsvg_section">
      <a name="customsvg"></a>
      <h1 id="customsvg_h1">Custom SVG</h1>
      <table id="token_customsvg_table" class="frontback_table"><tr>
        <th>
          <label for="token_customsvg_input_front">
          Front
          </label>
        </th>
        <th>
          <label for="token_customsvg_input_back">
          Back
          </label>
        </th>
        </tr><tr>
        <td>
          <textarea id="token_customsvg_input_front"
            onchange="alterCustomSVGToken(this)"
          >
          </textarea>
        </td>
        <td>
          <textarea id="token_customsvg_input_back"
            onchange="alterCustomSVGToken(this)"
          >
          </textarea>
        </td>
      </tr></table>
      <input id="token_customsvg_input_quantity" class="tokens_quantity"
        type="number" min="1" max=30" value="1"/>
      <button id="token_customsvg_button" class="btn modal-close"
        onclick="token_add(this)">
        <template id="token_customsvg_prototype">
        </template>
        <svg style="display:inline-block;" id="svg_token_customsvg"
          viewbox="0 0 80 90" width="24" height="24" >
          <use xlink:href="#token_customsvg_object" />
        </svg>
        Create
      </button>
    </section>
    <section>
    <h3>Examples:</h3>
    <p>Try pasting these into the box:</p>
      <table id="token_examples_table" class="frontback_table"><tr>
        <tr>
        <td colspan="2">
        Try this for the front / back in order to create a "poker chip"
        token that will interact with Dynamic Tray to do things like
        quickly calculate their sum.
        </td>
        </tr>
        <tr>
        <td>
          <pre>
&lt;circle
  r=&quot;36&quot; cy=&quot;45&quot; cx=&quot;40&quot;
  fill=&quot;black&quot;
/&gt;
&lt;text x=&quot;24&quot; y=&quot;65&quot;
  fill=&quot;white&quot;
  style=&quot;font-size:60px&quot;&gt;
&lt;tspan&gt;5&lt;/tspan&gt;
&lt;/text&gt;
          </pre>
        </td>
        <td>
          <pre>
&lt;circle
  r=&quot;36&quot; cy=&quot;45&quot; cx=&quot;40&quot;
  fill=&quot;white&quot;
/&gt;
&lt;text x=&quot;24&quot; y=&quot;65&quot;
  fill=&quot;black&quot;
  style=&quot;font-size:60px&quot;&gt;
&lt;tspan&gt;5&lt;/tspan&gt;
&lt;/text&gt;
          </pre>
        </td>
        </tr>
        <tr>
        <td colspan="2">
        Standee-style tokens can be made with the 
        <a href="https://www.heroforge.com/">HeroForge</a>
        customization tool or with
        <a href="https://blush.design/collections/open-peeps/pose-standing">OpenPeeps</a>
        (which is nicer because it lets you just copy the URL)
        <img src="img/standee_hero_front.png" height="32" />
        </td>
        </tr>
        <tr>
        <td>
          <pre>
&lt;image href=&quot;img/standee_hero_front.png&quot;
  width=&quot;80&quot; height=&quot;100&quot;
/&gt;
          </pre>
        </td>
        <td>
          <pre>
&lt;image href=&quot;https://blush.design/api/download?shareUri=zesJJD5hU&amp;s=0%7ED08B5B&amp;w=400&amp;h=400&amp;fm=png&quot;
  width=&quot;80&quot; height=&quot;100&quot;
/&gt;
          </pre>
        </td>
        </tr>
      </table>
    </section>
    </div>
  </div>

<!-- END TOKENS =============================================== END TOKENS -->

<!-- ACTIVITY LOG =============================================== ACTIVITY LOG -->
  <div class="modal" id="dialog_activity_log">
    <style>
      #activity_log_list li {
        background: #ddd;
        border-radius: 5px;
        display: flex;
        height: 80px;
        justify-content: space-between;
        list-style: none;
        margin-bottom: 4px;
        padding: 9px 9px 0 9px;
        text-align: right;
      }
      #activity_log_list li:nth-child(even) {
        background: #bbb;
      }
      .activity_item div {
        font-size: 24px;
        display: flex;
        align-items: center;
      }
      .activity_item span {
        padding-right: 8px;
      }
      #activity_log svg {
        vertical-align: bottom;
      }
      .activity_item .player_name {
        text-shadow: 1px 1px white;
      }
    </style>

    <nav class="dialog_nav"  id="activity_log_nav">
      <div class="nav-wrapper">
      <button class="btn dialog_cancel modal-close">
        &#215;
      </button>
      </div>
    </nav>
    <div class="modal-content">
      <section id="activity_log_section">
        <a name="activity_log"></a>
        <h1 id="activity_log_h1">Activity Log</h1>
        <ol id="activity_log_list"></ol>

        <template id="template_activity_item">
          <li class="activity_item">
            <div class="timestamp"></div>
            <div>
              <span class="player_name"></span>
              <span class="player_action"></span>
              <svg class="before_node"></svg>
              <span>&#9758;</span>
              <svg class="after_node"></svg>
            </div>
          </li>
        </template>

      </section>
    </div>
  </div>
<!-- /ACTIVITY LOG ============================================== /ACTIVITY LOG -->

<!-- CONTRIBUTE =============================================== CONTRIBUTE -->
  <div class="modal" id="dialog_contribute">
   <b>Did Togetherness Table help you today?</b>
   <p>If you enjoy this tool, you can spread the love:</p>
    <nav class="dialog_nav" id="contribute_nav">
    <div class="nav-wrapper">
      <button class="dialog_cancel btn modal-close"
        data-dialog-id="dialog_contribute"
      >
        &#215;
      </button>
      <ul class="left">
        <li><a href="#recognize">Spread the word</a></li>
        <li><a href="#develop">Contribute time</a></li>
        <li><a href="#donate">Donate to related causes</a></li>
        <li><a href="#controls">Help with controls</a></li>
      </ul>
    </div>
    </nav>
  <div class="modal-content">
    <section>
      <a name="controls"></a>
      <h1 class="contribute_h1">Controls</h1>
        To roll dice, either click on them once, then press the Roll button,
        or double-click on them. (Tap or double-tap on mobile devices).
      </p>
      <p>
        There are also keyboard shortcuts for most actions. You can type
        <b>r</b> to roll all the dice you have selected.
      <p>
        To remove cards from a deck, double-click on the deck so that you
        see the dashed border.
        The same technique works to remove objects from Dynamic Trays.
      </p>
      <p>
        Some objects, like Dynamic Trays, can be resized. To resize,
        double-click an object, then drag the gray square handle in the
        lower corner.
      </p>
      <p>
        To select multiple dice, hold <b>Shift</b> and click on each one.
        Otherwise, you can drag a selection box that covers all the objects
        you're targeting.
      </p>
      <p>
        To zoom in/out, hold <b>Ctrl</b> and roll your mouse wheel.
      </p>
    </section>
    <section>
      <a name="recognize"></a>
      <h1 class="contribute_h1">Give some recognition</h1>
      <div class="contribute_explain">
      If you do the whole social media thing:
      <a href="https://twitter.com/home?status=Thanks be to @boardcrafting for
      hosting https://www.1kfa.com/table !">By tweeting a tweet</a> or
      <a href="https://mastodon.social/">tooting a toot</a>.
      <p>
      If you've got a Github account, you can
      <a href="https://github.com/sjbrown/togetherness">"star" this project</a>
      or
      <a href="https://github.com/sjbrown/togetherness">report an issue</a>
      </div>
    </section>
    <section>
      <a name="develop"></a>
      <h1 class="contribute_h1">Contribute to the codebase</h1>
      <div class="contribute_explain">
      Speaking of Github, you can
      <a href="https://github.com/sjbrown/togetherness">fork and contribute to this project</a>
      </div>
    </section>
    <section>
      <a name="donate"></a>
      <h1 class="contribute_h1">Donate</h1>
      <div class="contribute_explain">
      This is built on top of TogetherJS, a free, open-source project created by
      the Mozilla Foundation. They need money to continue making great software
      like this.
      <a href="https://donate.mozilla.org/en-US/">Donate to Mozilla here.</a>
      </div>
    </section>
  </div>
  </div>
<!-- /CONTRIBUTE ============================================== /CONTRIBUTE -->


<!-- HINT CONTROLS ======================================== HINT CONTROLS -->
<div id="hint_controls">
  <style>
#hint_controls {
  position: absolute;
  top: 0;
  right: 200px;
  display: none;
}
  </style>
  <script>
window.addEventListener('load', () => {
  if (storage.getPreference('dismissHintControls') !== 'yes') {
    document.querySelector('#hint_controls').style.display = 'block'
  }
})
function dismissHintControls() {
  storage.setPreference('dismissHintControls', 'yes')
  document.querySelector('#hint_controls').style.display = 'none'
}
  </script>
  <button id="hint_controls_button" class="btn btn-small modal-trigger"
    data-target="dialog_contribute"
    data-dialog-id="dialog_contribute">
    Help with keyboard and mouse controls
  </button>
  <button id="hint_controls_dismiss" class="btn btn-small"
   onclick="dismissHintControls()"
  >
  &#215;
  </button>
</div>
<!-- /HINT CONTROLS ======================================== /HINT CONTROLS -->


<!-- =========================FOOTER==================== -->
<style>

#footer {
  flex-shrink: 0;
  display: flex;
  flex-direction: column;
  min-width: 80%;
  overflow: scroll;
  max-height: 100px;
}
@media screen and (max-width: 1200px) {
  #footer {
    min-width: 100%;
  }
}


.footerbar.inactive {
  animation: slide-out 0.5s forwards;
  visibility: collapse;
  padding: 0px 0px;
}

.footerbar {
  width: 100%;
  padding: 4px 10px;
  transition: background-color 2s;
  transition: transform 2s;
}

.graybg {
  background-color: #a0a0a0;
}

.bluebg {
  background-color: rgb(0, 149, 221);
}

.whitebg {
  background-color: #f0f0f0;
}

.footerbar h3 {
  display: inline;
}

</style>
  <div id="footer">
    <!-- =============SHARE URL BAR ==================== -->
    <div id="share_url_bar" class="inactive footerbar whitebg">
    <style>

     #share_url_bar td {
       padding: 0px;
       border-radius: 0px;
     }
     #share_url_bar tr {
       border: 0px;
     }
     #share_url_label {
       font-size: larger;
       margin-right: 40px;
     }
    </style>
      <table
      title="Share this URL with your friends and have them join you"
      >
      <tr>
      <td>
      <span id="share_url_label">Share URL:</span>
      </td>
      <td>
      <style>
      #share_url {
        font-family: monospace;
        display: inline-block;
        background-color: transparent;
        border: none;
        font-size: inherit;
        height: inherit;
        margin: inherit;

      }
      </style>
      <input id="share_url" value="" />
      </td>
      <td>
      <script>
      function copyURLToClipboard() {
        copyText = document.getElementById('share_url')
        /* Select the text field */
        copyText.select()
        copyText.setSelectionRange(0, 99999) /*For mobile devices*/
        document.execCommand("copy")
      }
      </script>
      <button id="share_url_copy_button" class="btn btn-small"
        onClick="copyURLToClipboard()"
      >Copy URL</button>
      </td>
      </tr>
      </table>
    </div>
    <!-- =================================DEBUG======================= -->
    <div id="debug_bar" class="footerbar inactive graybg debug_none">
    <script>
    window.addEventListener('load', () => {
      let q = new URLSearchParams(window.location.search)
      if (q.get('debug') === '1') {
        DEBUG = 1
        let bar = document.querySelectorAll('.debug_none').forEach(el => {
          el.classList.remove('debug_none')
          el.classList.remove('inactive')
        })
      }
    })
    </script>
    <style>
    .debug_none {
      display: none;
    }
    </style>
        <pre id="debug_bar_log">
        </pre>
    </div>
  </div>

</body>
</html>

