<html>
<head>
<title>Togetherness Table</title>
<meta charset="utf-8">

<!--
 The SVG viewport is the scrolling / panning / zooming area, so
 prevent touch events from zooming into the page
 ( from https://www.html5rocks.com/en/mobile/touchandmouse/ )
-->
<meta name="viewport" content="width=device-width,user-scalable=no">

<script>
/*
 *
 * Configure TogetherJS
 *
 */
TogetherJSConfig_hubBase = "https://togetherjs-hub.glitch.me/"
TogetherJSConfig_siteName = "table"
TogetherJSConfig_toolName = "Multiplayer"
//TogetherJSConfig_cloneClicks = "foo"; // This might be useful, or not
//TogetherJSConfig_dontShowClicks = "foo";
//TogetherJSConfig_enableShortcut = "foo";
TogetherJSConfig_suppressJoinConfirmation = true
TogetherJSConfig_suppressInvite = true
//TogetherJSConfig_includeHashInUrl = true
TogetherJSConfig_disableWebRTC = true
// Hack: to get stable Share URLs
TogetherJSConfig_findRoom = 'anonymous'
// Hack: I had to look into the TogetherJS source code for this one.
localStorage.setItem('togetherjs.settings.seenIntroDialog', true)


TogetherJSConfig_on_ready = () => {
  el = document.getElementById('share_url')
  el.value = TogetherJS.shareUrl()
  el = document.getElementById('share_url_bar')
  el.classList.remove('inactive')
  el.classList.add('active')
  el.classList.remove('whitebg')
  el.classList.add('bluebg')
}
TogetherJSConfig_on_close = () => {
  el = document.getElementById('share_url')
  el.value = ''
  el = document.getElementById('share_url_bar')
  el.classList.remove('active')
  el.classList.add('inactive')
  el.classList.remove('bluebg')
  el.classList.add('whitebg')
}
</script>
<script src="https://togetherjs.com/togetherjs-min.js"></script>
<script src="./svg_draggable.js"></script>
<script src="./come_together.js"></script>
<script src="./base32.js"></script>
<script src="./svg.js"></script>
<script src="./ui.js"></script>
<script src="./index.js"></script>
<script src="./spatial.js"></script>
<script src="./js/domJSON.js"></script>
<script src="./physicsjs-full.js"></script>

<link rel="stylesheet" type="text/css" href="animate.css">
<link rel="stylesheet" type="text/css" href="index.css">

<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/css/materialize.min.css">
<script src="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/js/materialize.min.js"></script>

<style type="text/css" />
@font-face {
  font-family: SubotypeSteady;
  src: url("subotype_steady.otf") format("opentype");
}
</style>


</head>

<script>
var svg_table;
var viewport;
var gViewport;
var origViewportSize = [1200, 800]

function initSvgTable(el) {
  el.id = 'svg_table'
  svg_table = SVG.adopt(el)
  svg_table.size(1200, 800)
  gViewport.add(svg_table)
  makeDraggable(SVG.adopt(byId('svg_viewport')), svg_table)
  return svg_table
}

SVG.on(document, 'DOMContentLoaded', () => {
  // Override the id-generating function of the svg.js library
  SVG.eid = (name) => {
    return name + '_' + base32.short_id()
  }

  viewport = SVG('gamearea').size(origViewportSize[0], origViewportSize[1])
  viewport.node.id = 'svg_viewport'
  viewport.node.setAttribute('overflow', 'scroll')
  viewport.node.style.overflow = 'scroll'
  s(viewport.node, 'width', viewport.node.parentNode.clientWidth)
  viewport.style('background-image', 'url(svg/bg_hexagons.svg)')
  viewport.node.addEventListener('svg_dragsafe_click', (e) => {
    //console.log("-0--------------------------", e.detail.elemId, viewport.node.id)
    if (e.detail.elemId === viewport.node.id) {
      ui.unmark_all_but()
    }
  })

  gViewport = SVG.adopt(document.createElementNS(SVG.ns, 'g'))
  gViewport.node.id = 'g_viewport'
  viewport.add(gViewport)

  table_rect = gViewport.rect()
  table_rect.attr({
     x: -1,
     y: -1,
     rx: 0,
     ry: 0,
     width: 1202,
     height: 802,
     fill: 'none',
     stroke: 'black',
     'stroke-width': 10,
     'stroke-opacity': 0.2,
  })

  svg_table = initSvgTable(document.createElementNS(SVG.ns, 'svg'))
  //#makeDraggable(viewport, svg_table)

  document.addEventListener('svg_dragend', (evt) => {
    selectedElement = byId(evt.detail.elemId)
    //net_fire({type: "change", data: serialize(selectedElement)})
    push_sync()
  })

  window.addEventListener("resize", () => {
    let g = byId('gamearea')
    viewport.width(g.clientWidth)
    viewport.height(g.clientHeight)
  })

  // Initialize modals
  instances = M.Modal.init(document.querySelectorAll('.modal'), {
    opacity: 0.75,
  });
})

var currentZoom = 1.0;
function zoom(inOrOut) {
  zooms = {
    0.5: { out: 0.5, in: 0.6 },
    0.6: { out: 0.5, in: 0.7 },
    0.7: { out: 0.6, in: 0.8 },
    0.8: { out: 0.7, in: 0.9 },
    0.9: { out: 0.8, in: 1.0 },
    1.0: { out: 0.9, in: 1.25 },
    1.25: { out: 1.0, in: 1.5 },
    1.5: { out: 1.25, in: 1.75 },
    1.75: { out: 1.5, in: 1.75 },
  }
  let oldZoom = currentZoom
  currentZoom = zooms[currentZoom][inOrOut];
  console.log("c", currentZoom, "o", oldZoom)
  if (oldZoom === currentZoom) {
    return
  }
  let w_prime = parseInt(origViewportSize[0] * currentZoom)
  let h_prime = parseInt(origViewportSize[1] * currentZoom)
  viewport.node.setAttribute('width', w_prime)
  viewport.node.setAttribute('height', h_prime)
  viewport.node.setAttribute(
    'viewBox',
    `0 0 ${svg_table.width()} ${svg_table.height()}`
  )
}

function downKey(e) {
  if (e.target.tagName.toLowerCase() !== 'body') { return }
  if (e.altKey || e.shiftKey || e.metaKey || e.ctrlKey) { return }
  button = null
  document.querySelectorAll('button').forEach((x) => {
    if (button && x.accessKey === e.key) {
      console.error('Two buttons have the same accessKey', x.accessKey)
      return
    }
    if (x.accessKey === e.key) {
      button = x
    }
  })
  if (button) {
    button.click()
  }
}

window.addEventListener('load', () => {
  document.querySelector('body').addEventListener('keydown', downKey)
  load_profile_ui()
  loadPrototypeDN()
  TogetherJSConfig_getUserColor = getUserColor
  TogetherJSConfig_getUserName = function () {
    return localStorage.getItem('profile_name') || base32.short_id()
  };
  TogetherJSConfig_findRoom = TogetherJSConfig_getUserName()
})

</script>

<body>

<!-- ==================================================================== -->
<style>
#gamearea {
  max-width: 100%;
  min-width: 80%;
  min-height: 60%;
  background-color: #efe;
  margin-left: 80px;
}


@media screen and (max-width: 900px) {
  #gamearea {
    max-width: 100vw;
    height: 100vh;
    margin-left: 0px;
  }
}
</style>

  <div id="gamearea" contextmenu="gamemenu">
  <!--
  <svg id="svgdoc" width="100%" height="500" onload="initDraggable()">
  </svg>
  -->
  <svg width="0" height="0">
  <filter id="app-filter-colorize" color-interpolation-filters="sRGB" >
    <feColorMatrix id="recolorize-filter-matrix" type="matrix"
       values="0.9 0.0 0.0 0.0  0.0
               0.9 0.0 0.0 0.0  0.0
               0.9 0.0 0.0 0.0  0.0
               0.0 0.0 0.0 1.0  0.0" />
  </filter>
  </svg>
  </div>
<!-- ==================================================================== -->
<!-- ==================================================================== -->

<!-- ==================================================================== -->
<div class="hud_overlay" id="hud_overlay_left">
<style>
.hud_overlay {
  z-index: 100;
  pointer-events: none;
}
#hud_overlay_left {
  position: fixed;
  top: 0;
  left: 0;
  bottom: 0;
  height: auto;
  display: flex;
  flex-direction: column;
  justify-content: center;
}

#hud_overlay_right {
  position: fixed;
  top: 0;
  right: 0;
  bottom: 0;
  height: auto;
  display: flex;
  flex-direction: column;
  justify-content: center;
}

#hud_overlay_top {
  position: fixed;
  top: 0;
  right: 0;
  left: 0;
  height: auto;
  display: flex;
  flex-direction: row;
  justify-content: center;
}

.hudmenu {
  pointer-events: auto;
  position: relative;
  background-color: #030303;
}

.hudmenu-left {
  border-top-right-radius: 5px;
  border-bottom-right-radius: 5px;
  max-width: 100px;
  display: inline-block;
}
.hudmenu-right {
  border-top-left-radius: 5px;
  border-bottom-left-radius: 5px;
  display: flex;
  flex-direction: column;
  align-items: right;
  justify-content: right;
  max-width: 10em;
  right: 0%;
}
@media only screen and (max-width: 900px) {
  .hudmenu {
    top: auto;
    bottom: 0;
  }
  .hudmenu-right {
    left: auto;
    right: 0;
  }
}

.hudmenu button {
  min-width: 7em;
  min-height: 7em;
  padding: 1em;
  font-size: 8pt;
  background-color: #030303;
}

.hudmenu-right button {
  min-width: 150px;
  min-height: 7em;
  padding: 1em;
  font-size: 8pt;
}
.hudmenu .btn {
  opacity: 80%;
  color: #f0f0f0;
}
.hudmenu .btn:hover {
  background-color: #000000;
  opacity: 100%;
  color: #ffffff;
}
.hudmenu .btn:focus {
  background-color: #a0a0a0;
}
.hudmenu button[accessKey]::first-letter {
  text-decoration: underline;
}
@media only screen and (max-height: 600px) {
  .hudmenu button {
    min-height: 3em;
  }
}

.hudmenu .player_menu_button_mobile {
display: none;
}
.collapsegroup > .collapsible {
  overflow: hidden;
  transition: max-height 0.2s ease-out;
  margin: 0px;
  border: none;
}
.initial > .collapsible {
  max-height: 1000px;
}
.collapsed > .collapsible {
  max-height: 0px;
  margin: 0px;
}
.collapsetoggle:after {
  content:" ▾";
}
.collapsed > .collapsetoggle:after {
  content:" ☰";
}

@media only screen and (max-width: 900px) {
  .initial > .collapsible {
    max-height: 0px;
  }
  .initial > .collapsetoggle:after {
    content:" ☰";
  }
  .hudmenu .player_menu_button_large {
    display: none;
    border: red;
  }
  .hudmenu .player_menu_button_mobile {
    display: block;
  }
}


</style>
<script>
  // Do not scroll when swiping around on a menu
  window.addEventListener('load', () => {
    document.querySelectorAll('.hudmenu').forEach(el => {
      el.addEventListener('scroll', (evt) => {
        evt.preventDefault()
        evt.stopPropagation()
      })
      el.addEventListener('touchmove', (evt) => {
        evt.preventDefault()
        evt.stopPropagation()
      })
    })
  })
</script>
<section class="hudmenu hudmenu-left buttongroup collapsegroup" id="buttongroup_table">
  <button id="quick_die_button" class="btn btn-small"
    onclick="quick_die_button_add()"
    title="Add one die of the most recent type"
    >
    <img src="svg/v1/dice_d6.svg"  height="48" data-serialized-state=""/>
  </button>
  <script>
  function quick_die_button_add() {
    url = document.querySelector('#quick_die_button img').src
    add_object( url, { 'center': [50, 50] })
  }
  window.addEventListener('load', () => {
    window.addEventListener('create', (e) => {
      redDot = 'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAUAAAAFCAYAAACNbyblAAAAHElEQVQI12P4//8/w38GIAXDIBKE0DHxgljNBAAO9TXL0Y4OHwAAAABJRU5ErkJggg=='
      newSrc = e.detail.createdEl.dataset.appUrl || redDot
      document.querySelector('#quick_die_button img').src = newSrc
    })
  })

  </script>

  <div id="dice_button_wrapper">
  <style>
  #dice_button_slide {
    display: none;
  }
  #dice_button_slide td {
    padding: 0px;
  }
  #dice_button_wrapper:hover #dice_button_slide {
    display: inline-block;
    position: absolute;
    //transform: translate(100px);
  }
  </style>
  <button id="dice_dialog_button" class="btn btn-small modal-trigger"
    accesskey="d"
    data-target="dialog_dice"
    data-dialog-id="dialog_dice">
    + <u>D</u>ice
  </button>
  <div id="dice_button_slide">
      <table><tr>
      <td>
        <button class="btn" id="dice_button_d4"
          onclick="add_object('svg/v1/dice_d4.svg', { center: [50,50] })"
          >
          <img src="svg/v1/dice_d4.svg" height="48" />
        </button>
      </td>
      <td>
        <button class="btn" id="dice_button_d6"
          onclick="add_object('svg/v1/dice_d6.svg', { center: [50,50] })"
          >
          <img src="svg/v1/dice_d6.svg" height="48" />
        </button>
      </td>
      <td>
        <button class="btn" id="dice_button_d8"
          onclick="add_object('svg/v1/dice_d8.svg', { center: [50,50] })"
          >
          <img src="svg/v1/dice_d8.svg" height="48" />
        </button>
      </td>
      <td>
        <button class="btn" id="dice_button_d10"
          onclick="add_object('svg/v1/dice_d10.svg', { center: [50,50] })"
          >
          <img src="svg/v1/dice_d10.svg" height="48" />
        </button>
      </td>
      <td>
        <button class="btn" id="dice_button_d12"
          onclick="add_object('svg/v1/dice_d12.svg', { center: [50,50] })"
          >
          <img src="svg/v1/dice_d12.svg" height="48" />
        </button>
      </td>
      <td>
        <button class="btn" id="dice_button_d20"
          onclick="add_object('svg/v1/dice_d20.svg', { center: [50,50] })"
          >
          <img src="svg/v1/dice_d20.svg" height="48" />
        </button>
      </td>
      </tr></table>
  </div>
  </div>

  <button id="cards_dialog_button" class="btn btn-small modal-trigger"
    accesskey="c"
    data-target="dialog_cards"
    data-dialog-id="dialog_cards">
  + <u>C</u>ards
  </button>
<!--
  <button class="btn" onclick="add_object('svg/v1/deckahedron.svg')">
  + Deckahedron
  </button>

  <button id="pbta_button" class="btn btn-small modal-trigger"
    onclick="add_object('svg/v1/pbta.svg')"
    >
    + pbta
  </button>
  -->
  <button id="clocks_dialog_button" class="btn btn-small modal-trigger"
    accesskey="k"
    data-target="dialog_clocks"
    data-dialog-id="dialog_clocks">
    + Cloc<u>k</u>s
  </button>

  <button id="other_button" class="btn btn-small modal-trigger"
    accesskey="o"
    data-target="dialog_other"
    data-dialog-id="dialog_other">
    + <u>O</u>ther
  </button>

  <button id="table_button" class="btn btn-small"
    onclick="ui_popup_dialog_table()"
    accesskey="t"
    >
    <u>T</u>able
  </button>

</section>
</div> <!-- end hud_overlay_left -->


<!-- ==================================================================== -->
<div class="hud_overlay" id="hud_overlay_right">
<script>
window.addEventListener('load', () => {
  document.querySelector('.player_menu_button_large')
  .addEventListener('click', (e) => {
      cgroup = e.target.closest('.collapsegroup')
      cgroup.classList.toggle('active')
      if (cgroup.classList.contains('initial')) {
        cgroup.classList.remove('initial')
      }
      cgroup.classList.toggle('collapsed')
  })
  document.querySelector('.player_menu_button_mobile')
  .addEventListener('click', (e) => {
      cgroup = e.target.closest('.collapsegroup')
      cgroup.classList.toggle('active')
      if (cgroup.classList.contains('initial')) {
        cgroup.classList.remove('initial')
      } else {
        cgroup.classList.toggle('collapsed')
      }
  })
})
</script>
<section class="hudmenu hudmenu-right buttongroup collapsegroup initial" id="buttongroup_player">
<button class="player_menu_button_large collapsetoggle btn" name="playermenu" >Player</button>
<button class="player_menu_button_mobile collapsetoggle btn mobile" name="playermenu" >Player</button>
<div class="collapsible">

  <button id="profile_button" class="btn btn-small modal-trigger"
    title="Profile"
    data-target="dialog_profile"
    data-dialog-id="dialog_profile">
    <span class="colorsample" style="color: #ffffff00">■</span>
    <span id="profile_button_span">Profile</span>
    <span class="colorsample" style="color: #ffffff00">■</span>
  </button>

  <button id="save_button" class="btn btn-small"
    onclick="ui_popup_dialog_save()"
    data-dialog-id="dialog_save">
    Save
  </button>

  <button id="load_button" class="btn btn-small"
    onclick="ui_popup_dialog_load()"
    data-dialog-id="dialog_load">
    Load
  </button>

  <button id="help_button" class="btn btn-small modal-trigger"
    title="Help/About this project"
    data-target="dialog_contribute"
    data-dialog-id="dialog_contribute">
    Help / About
  </button>

  <button class="btn btn-small" onclick="TogetherJS(this); return false;"
    title="Invite / Join Friends"
    id="start-togetherjs"
  >Multiplayer</button>

</div>
</section>
</div> <!-- end hud_overlay_right -->


<!-- ==================================================================== -->

<div class="hud_overlay" id="hud_overlay_top">
<!-- =============OBJECT ACTIONS ==================== -->
<style>
.central_collapser {
  text-align: center;
  position: relative;
}
.central_collapser .collapsetoggle {
  width: 100%;
  background-color: rgb(0,0,0,0);
  vertical-align: middle;
  border: none;
  display: inline-block;
  border-bottom: 1px solid rgb(200,200,200,0.5);
}
#object_actions {
  background-color: #030303;
  opacity: 80%;
  color: #f0f0f0;
}
#object_actions_header {
  font-size: larger;
  padding: 0px 10px;
}
@media only screen and (max-width: 900px) {
  #object_actions {
    position: fixed;
    max-width: 200px;
  }
  .central_collapser .collapsetoggle {
    min-height: 25px;
  }
  #object_actions_header {
    font-size: normal;
    margin: 4px 0px;
    line-height: 100%;
  }
}
</style>
<script>
window.addEventListener('load', () => {
  document.querySelector('.central_collapser .collapsetoggle')
  .addEventListener('click', (e) => {
      cgroup = e.target.closest('.collapsegroup')
      cgroup.classList.toggle('active')
      cgroup.classList.toggle('collapsed')
  })
})
</script>
<div id="object_actions" class="central_collapser collapsegroup">
  <button class="collapsetoggle" name="toggle_object_actions"></button>
  <div class="collapsible hudmenu hudmenu-top">
    <h3 id="object_actions_header">Select objects by clicking on them</h3>
    <template id="template_object_actions">
      <button class="btn btn-large">Button label</button>
    </template>
  </div>
</div>
</div> <!-- end hud_overlay_top -->


<!-- PROFILE  =============================================== PROFILE -->
  <script>
function ui_change_profile(evt) {
  name_input = byId('profile_input_name')
  color_input = byId('profile_input_color')
  if (!name_input.value) {
    return;
  }
  localStorage.setItem('profile_name', name_input.value)
  localStorage.setItem('profile_color', color_input.value)
  load_profile_ui()
  ui.popdown_dialog('dialog_profile')
  net_fire({ type: 'change_profile', data: name_input.value })
}
function load_profile_ui() {
  name = localStorage.getItem('profile_name') || ''
  color = localStorage.getItem('profile_color')
  if (!name) {
    return
  }
  TogetherJS.refreshUserData()
  TogetherJSConfig_findRoom = name
  input = document.querySelector('#profile_input_name')
  input.value = name
  input = document.querySelector('#profile_input_color')
  input.value = color
  profile_bs = document.querySelector('#profile_button_span')
  document.querySelectorAll('#profile_button > .colorsample').forEach((el) => {
    el.style.color = color
  })
  profile_bs.textContent = name
}
  </script>
  <div class="modal" id="dialog_profile">
    <button class="dialog_cancel btn modal-close"
      data-dialog-id="dialog_profile"
    > &#215; </button>
  <div class="modal-content">
    <label for="profile_input_name">Name</label>
    <input id="profile_input_name" type="text" value="" />
    <label for="profile_input_color">Color
    <input id="profile_input_color" type="color" value="#ffffff"
    />
    </label>
    <br />
    <button class="btn" id="dialog_profile_submit"
      onclick="ui_change_profile(this)">
      Update
    </button>
  </div>
  </div>
<!-- /PROFILE ============================================== /PROFILE -->

<!-- SAVE ============================================================ SAVE -->
  <div id="dialog_save" class="modal">
  <script>
function ui_popup_dialog_save() {
  if(document.querySelectorAll('#svg_table').length > 1) {
    alert('too many svg_table elements')
  }
  elJSON = domJSON.toJSON(
    byId('svg_table'),
    { domProperties: false }
  )
  fragment = domJSON.toDOM(elJSON)
  var dd = document.createElement('div')
  dd.appendChild(fragment)
  textarea = byId('textarea_save_output')
  textarea.value = dd.innerHTML
  return ui.popup_dialog({'data-dialog-id': 'dialog_save'})
}
  </script>
    <nav class="dialog_nav"  id="save_nav">
    <div class="nav-wrapper">
      <button class="btn dialog_cancel modal-close">
        &#215;
      </button>
      <ul class="left">
        <li><a href="#copy_and_paste">Copy/Paste</a></li>
        <li><a href="#local">Local storage</a></li>
        <li><a href="#cloud">Cloud storage</a></li>
      </ul>
    </div>
    </nav>
  <div class="modal-content">
    <section>
      <a name="copy_and_paste"></a>
      <h1 >Copy and Paste</h1>
      <textarea id="textarea_save_output" cols="82" rows=10>X</textarea>
      <div class="save_explain">
      Copy and paste the contents of this text box to a file on your computer.
      </div>
    </section>
    <section>
      <a name="local"></a>
      <h1 >Local storage on your browser</h1>
      <div class="save_explain">
      This feature has not been implemented yet. If you would like it to exist,
      <span style="color:teal">tweet</span> "Hey @boardcrafting, please
      make Local Storage work on http://1kfa.com/table ! #ttrpg #1kfa
      #featurerequest"
      <b>or</b> start participating with the development on Github
      </div>
    </section>
    <section>
      <a name="cloud"></a>
      <h1 >Cloud storage</h1>
      <div class="save_explain">
      This feature has not been implemented yet. If you would like it to exist,
      <span style="color:teal">tweet</span> "Hey @boardcrafting, please
      make Cloud Storage work on http://1kfa.com/table ! #ttrpg #1kfa
      #featurerequest"
      <b>or</b> start participating with the development on Github
      </div>
    </section>
  </div>
  </div>
<!-- /SAVE ========================================================== /SAVE -->


<!-- LOAD ============================================================ LOAD -->
  <div id="dialog_load" class="modal">
  <script>
async function load_svg() {
  textarea = byId('textarea_load_input')
  let table = byId('svg_table')

  newDoc = new DOMParser().parseFromString(textarea.value, 'image/svg+xml')
  if (newDoc.firstChild.id !== 'svg_table') {
    alert('Save file corrupted!\n(Did you intend to add an SVG doc with the Other menu?)')
    return
  }
  //defanged = domJSON.toJSON(newDoc.firstChild)
  //docFragment = domJSON.toDOM(defanged)
  table.parentNode.replaceChild(newDoc.firstChild, table)
  table = byId('svg_table')

  initSvgTable(table)
  table  = byId('svg_table')

  // Async stuff happens here, so iterate with an old school for() loop
  nl = table .querySelectorAll('[data-app-url]')
  for(var i=0; i < nl.length; i ++) {
    elem = nl[i]
    await import_foreign_svg(elem.dataset.appUrl)
  }

  add_fresh_svg(table)

  return ui.popdown_dialog('dialog_load')
}
function ui_popup_dialog_load() {
  textarea = byId('textarea_load_input')
  textarea.value = ''
  textarea.innerHTML = ''
  return ui.popup_dialog({'data-dialog-id': 'dialog_load'})
}
  </script>
    <nav class="dialog_nav" id="load_nav">
    <div class="nav-wrapper">
    <button class="dialog_cancel btn modal-close"
      data-dialog-id="dialog_load"
    >
      &#215;
    </button>
      <ul class="left">
        <li><a href="#copy_and_paste">Copy/Paste</a></li>
        <li><a href="#upload">Upload file</a></li>
      </ul>
    </div>
    </nav>
  <div class="modal-content">
    <section>
      <a name="copy_and_paste"></a>
      <h1 class="load_h1">Copy and Paste</h1>
      <textarea id="textarea_load_input" cols="82" rows=5></textarea>
      <div class="load_explain">
      Copy and paste the contents from a previously saved session into this
      text box.
      </div>
      <button class="btn btn-dialog btn-primary" onclick="load_svg()">
      Load
      </button>
    </section>
    <section>
      <a name="upload"></a>
      <h1 class="load_h1">Upload file</h1>
      <div class="load_explain">
      This feature has not been implemented yet. If you would like it to exist,
      <span style="color:teal">tweet</span> "Hey @boardcrafting, please make
      file uploading
      work on http://1kfa.com/table ! #ttrpg #1kfa #featurerequest"
      <b>or</b> start participating with the development on Github
      </div>
    </section>
  </div>
  </div>
<!-- /LOAD ========================================================== /LOAD -->


<!-- TABLE  =============================================== TABLE -->
  <script>
function ui_popup_dialog_table() {
  let wInput = byId('table_width_input')
  let hInput = byId('table_height_input')
  wInput.value = svg_table.width()
  hInput.value = svg_table.height()
  return ui.popup_dialog({'data-dialog-id': 'dialog_table'})
}

function ui_change_background() {
  input = byId('background_url')
  if (!input.value) {
    return;
  }
  var value = "url('" + input.value + "')";
  viewport.style('background-image', value)
  ui.popdown_dialog('dialog_table')
  push_sync()
}

function ui_change_table_size() {
  let wInput = byId('table_width_input')
  let hInput = byId('table_height_input')

  svg_table.width(parseInt(wInput.value))
  svg_table.height(parseInt(hInput.value))
  table_rect.width(svg_table.width() + 2)
  table_rect.height(svg_table.height() + 2)
  viewport.node.setAttribute(
    'viewBox',
    `0 0 ${svg_table.width()} ${svg_table.height()}`
  )

  ui.popdown_dialog('dialog_table')
  push_sync()
}
  </script>
  <div class="modal" id="dialog_table">
    <button class="dialog_cancel btn modal-close"
      data-dialog-id="dialog_table"
    >
      &#215;
    </button>
  <div class="modal-content">
    <section>
    <h1>Background</h1>
    Use a URL as a background.  Examples:
    <ul>
      <li>http://www.1kfa.com/table/svg/bg_topography.svg
      <li>http://www.1kfa.com/table/svg/bg_hexagons.svg
    </ul>
    <label for="background_url">Enter a URL</label>
    <input id="background_url" type="url"
      value="http://www.1kfa.com/table/svg/bg_topography.svg"
    />
    <button class="btn" id="dialog_bg_submit"
      onclick="ui_change_background()">
      Change Background URL
    </button>
    </section>
    <section>
    <h1>Size</h1>
    <fieldset id="table_size_input_fields">
    <label>
      <span >Width:</span>
      <input id="table_width_input" type="number"
        min="500"
        max="10000"
        value="10"/>
    </label>
    <label>
      <span >Height:</span>
      <input id="table_height_input" type="number"
        min="500"
        max="10000"
        value="10"/>
    </label>
    </fieldset>
    <br />
    <button id="dialog_table_size_submit"
      class="btn"
      onclick="ui_change_table_size()">
      Change Size
    </button>
    </section>
  </div>
  </div>
<!-- /TABLE ============================================== /TABLE -->


<!-- TEXT_INPUT  =============================================== TEXT_INPUT -->

  <div class="modal" id="dialog_text_input">
    <script>

function ui_popup_text_input(el, name, currentVal, eventToFire) {
  let template = byId('popup_text_input_template')
  let inputDiv = template.cloneNode(true)
  template.parentElement.appendChild(inputDiv)
  inputDiv.style.display = 'block'
  inputDiv.id = 'popup_text_input'
  var submitButton = inputDiv.querySelector('#dialog_text_input_submit')

  submitButton.addEventListener('click', (evt) => {
      var target = el
      target.dispatchEvent( new CustomEvent(eventToFire, {
        bubbles: true,
        detail: {
          inputValue: inputDiv.querySelector('#text_input_input').value,
        }
      }))
      inputDiv.remove()
      ui.popdown_dialog('dialog_text_input')
  });

  byId('text_input_label_text').textContent = name
  inputDiv.querySelector('#text_input_input').value = currentVal
  return ui.popup_dialog({'data-dialog-id': 'dialog_text_input'})
}
    </script>
    <button class="dialog_cancel btn modal-close"
      data-dialog-id="dialog_text_input"
    >
      &#215;
    </button>
  <div id="popup_text_input_template" class="modal-content"
    style="display:none"
  >
    <fieldset id="text_input_fields">
    <label id="text_input_label" >
      <span id="text_input_label_text">Enter text:</span>
      <input id="text_input_input" type="text" value="x"/>
    </label>
    </fieldset>
    <br />
    <button id="dialog_text_input_submit">
      Change
    </button>
  </div>
  </div>
<!-- /TEXT_INPUT  ============================================= /TEXT_INPUT -->

<!-- PROPERTIES  =============================================== PROPERTIES -->

  <div class="modal" id="dialog_properties">
    <script>
function ui_popup_button() {
  var allSel = svg_table.select('[data-ui-marked]').members
  if (allSel.length !== 1) {
    alert('You must mark exactly 1 object to edit its properties');
    return
  }
  var el = allSel[0].node.firstChild;
  return ui_popup_properties(el, {'data-dialog-id': 'dialog_properties'})
}

function ui_popup_properties(el, dialog_specifier) {
  var submitButton = byId('dialog_properties_submit')
  var attrs = ui.justNonUiAttributes(el)

  submitButton.addEventListener('click', (evt) => {
      var target = el

      if (is_marked(target)) {
        ui.unmark({target: target.parentNode.lastChild})
      }

      var inputs = document.getElementsByClassName('properties_input')
      Array.prototype.map.call(inputs, (input) => {
        var name = g(input, 'name')
        if (name) {
          //console.log('setting', target, name, input.value)
          s(target, name, input.value);
        }
      });

      ui.popdown_dialog('dialog_properties')
      //net_fire({ type: 'change', data: serialize(target) })
      push_sync()
  });

  fieldset = byId('properties_fields')
  // first, clean up earlier messes
  var to_remove = []
  fieldset.childNodes.forEach((el) => {
    if (!el.classList || !el.classList.contains('template')) {
      to_remove.push(el)
    }
  });
  to_remove.map((el) => { el.remove() });

  inputTemplate = byId('properties_input_template')
  labelTemplate = byId('properties_label_template')
  Object.keys(attrs).map((key) => {
    input = inputTemplate.cloneNode(true)
    label = labelTemplate.cloneNode(false)
    s(label, 'id', 'properties_label_' + key)
    label.innerText = key;
    label.appendChild(input)
    s(input, 'name', key)
    s(input, 'id', 'properties_' + key)
    s(input, 'value', attrs[key])
    if (key.indexOf('data-') !== -1 ) {
      s(input, 'disabled', 'disabled')
    }
    input.classList.add('properties_input')
    input.classList.remove('template')
    label.classList.remove('template')
    fieldset.appendChild(label)
  })
  return ui.popup_dialog(dialog_specifier)
}
    </script>
    <button class="dialog_cancel btn modal-close"
      data-dialog-id="dialog_properties"
    >
      &#215;
    </button>
  <div class="modal-content">
    <fieldset id="properties_fields">
    <label id="properties_label_template" class="template" >
      Template
      <input id="properties_input_template" class="template" type="text" value="x"/>
    </label>
    </fieldset>
    <br />
    <button id="dialog_properties_submit">
      Change
    </button>
  </div>
  </div>
<!-- /PROPERTIES  ============================================= /PROPERTIES -->


<!-- DIALOG_DICE ============================================= DIALOG_DICE -->

  <div class="modal" id="dialog_dice">
  <style>
  @media only screen and (max-width: 900px) {
    .modal table .btn {
      padding: 0px;
    }
  }
  .dice_section {
    margin-bottom: 80px;
  }
  #dialog_dice .dice_input_table .dice_quantity {
    width: 40%;
  }
  </style>
    <script>

function add_dtype(dtype, inputEl, center, serializedState) {
  console.log("add dtype", dtype, 'state', serializedState)
  num = parseInt(inputEl.value) || 0
  for( var i=0; i < num; i++ ) {
    add_object(
      'svg/v1/dice_' + dtype +'.svg',
      {
        // Wrap 'center' in a new array to avoid async bugs
        'center': [center[0], center[1]],
        'serializedState': serializedState,
      },
    )
    center[0] = center[0] + 90
    center[1] = center[1] + 10
  }
  inputEl.value = 0
}

function diceIncrement(dtype) {
  el = byId('dice_input_' + dtype)
  num = parseInt(el.value) || 0
  el.value = num + 1
  return true
}

function ui_submit_dice(section) {
  //console.log('submit', section)
  center = [50, 50]
  if (section === 'sw') {
    dtypes = ['sw_d61', 'sw_d62', 'sw_d81', 'sw_d82', 'sw_d121', 'sw_d122', 'sw_d123']
    dtypes.forEach((dtype) => {
      add_dtype(dtype, byId('dice_input_' + dtype), center)
    })
  } else if (section === 'fudge') {
    dtypes = ['fudge_d6',]
    dtypes.forEach((dtype) => {
      add_dtype(dtype, byId('dice_input_' + dtype), center)
    })
  } else if (section === 'special') {
    add_dtype(
      'dn', byId('dice_input_dn'), center,
      document.querySelector('#dn_prototype svg')
    )
    add_dtype(
      'dsymbol', byId('dice_input_dsymbol'), center,
      {
        faces: byId('dice_input_dsymbol_faces').value
      }
    )
  } else {
    dtypes = ['d4', 'd6', 'd8', 'd10', 'd12', 'd20']
    dtypes.forEach((dtype) => {
      add_dtype(dtype, byId('dice_input_' + dtype), center)
    })
  }
  ui.popdown_dialog('dialog_dice')
}

    </script>
    <nav class="dialog_nav" id="dialog_dice_nav">
    <div class="nav-wrapper">
      <button class="dialog_cancel btn modal-close"
        data-dialog-id="dialog_dice"
      >
        &#215;
      </button>
      <ul class="left">
        <li><a href="#standard">Standard Dice</a></li>
        <li><a href="#sw">SW / Genesys Dice</a></li>
        <li><a href="#fudge">FUDGE Dice</a></li>
        <li><a href="#special">Special Dice</a></li>
      </ul>
    </div>
    </nav>
  <div class="modal-content">
    <section class="dice_section" id="standard_dice_section">
      <a name="standard"></a>
      <h1 id="standard_dice_h1">Standard Dice</h1>
      <!--
      <label for="dice_text_input">Add dice via text specification</label>
      <input id="dice_text_input" type="text" placeholder="1d10, 2d20"/>
      -->
      <table class="dice_input_table"><tr>
      <td>
        <button class="btn" id="dice_button_d4" onclick="diceIncrement('d4')">
          <img src="svg/v1/dice_d4.svg" width="24" height="24" />
        </button>
        &#215;
        <input class="dice_quantity" id="dice_input_d4" type="number" min="0"
          value="0"/>

      </td>
      <td>
        <button class="btn" id="dice_button_d6" onclick="diceIncrement('d6')">
          <img src="svg/v1/dice_d6.svg" width="24" height="24" />
        </button>
        &#215;
        <input id="dice_input_d6" type="number" class="dice_quantity" min="0" value="0"/>
      </td>
      <td>
        <button class="btn" id="dice_button_d8" onclick="diceIncrement('d8')">
          <img src="svg/v1/dice_d8.svg" width="24" height="24" />
        </button>
        &#215;
        <input id="dice_input_d8" type="number" class="dice_quantity" min="0" value="0"/>
      </td>
      <td>
        <button class="btn" id="dice_button_d10" onclick="diceIncrement('d10')">
          <img src="svg/v1/dice_d10.svg" width="24" height="24" />
        </button>
        &#215;
        <input id="dice_input_d10" type="number" class="dice_quantity" min="0" value="0"/>
      </td>
      <td>
        <button class="btn" id="dice_button_d12" onclick="diceIncrement('d12')">
          <img src="svg/v1/dice_d12.svg" width="24" height="24" />
        </button>
        &#215;
        <input id="dice_input_d12" type="number" class="dice_quantity" min="0" value="0"/>
      </td>
      <td>
        <button class="btn" id="dice_button_d20" onclick="diceIncrement('d20')">
          <img src="svg/v1/dice_d20.svg" width="24" height="24" />
        </button>
        &#215;
        <input id="dice_input_d20" type="number" class="dice_quantity" min="0" value="0"/>
      </td>
      </tr></table>
      <button id="dialog_submit_standard" onclick="ui_submit_dice('standard')"
        class="btn modal-close">
        Submit
      </button>
    </section>
    <section class="dice_section" id="sw_dice_section">
      <a name="sw"></a>
      <h1 id="sw_dice_h1">SW / Genesys Dice</h1>
      <table class="dice_input_table"><tr>
      <td>
        <button class="btn" id="dice_button_sw_d61" onclick="diceIncrement('sw_d61')">
          <img src="svg/v1/dice_sw_d61.svg" width="24" height="24" />
        </button>
        &#215;
        <input id="dice_input_sw_d61" type="number" class="dice_quantity" min="0" value="0"/>
      </td>
      <td>
        <button class="btn" id="dice_button_sw_d62" onclick="diceIncrement('sw_d62')">
          <img src="svg/v1/dice_sw_d62.svg" width="24" height="24" />
        </button>
        &#215;
        <input id="dice_input_sw_d62" type="number" class="dice_quantity" min="0" value="0"/>
      </td>
      <td>
        <button class="btn" id="dice_button_sw_d81" onclick="diceIncrement('sw_d81')">
          <img src="svg/v1/dice_sw_d81.svg" width="24" height="24" />
        </button>
        &#215;
        <input id="dice_input_sw_d81" type="number" class="dice_quantity" min="0" value="0"/>
      </td>
      <td>
        <button class="btn" id="dice_button_sw_d82" onclick="diceIncrement('sw_d82')">
          <img src="svg/v1/dice_sw_d82.svg" width="24" height="24" />
        </button>
        &#215;
        <input id="dice_input_sw_d82" type="number" class="dice_quantity" min="0" value="0"/>
      </td>
      <td>
        <button class="btn" id="dice_button_sw_d121" onclick="diceIncrement('sw_d121')">
          <img src="svg/v1/dice_sw_d121.svg" width="24" height="24" />
        </button>
        &#215;
        <input id="dice_input_sw_d121" type="number" class="dice_quantity" min="0" value="0"/>
      </td>
      <td>
        <button class="btn" id="dice_button_sw_d122" onclick="diceIncrement('sw_d122')">
          <img src="svg/v1/dice_sw_d122.svg" width="24" height="24" />
        </button>
        &#215;
        <input id="dice_input_sw_d122" type="number" class="dice_quantity" min="0" value="0"/>
      </td>
      <td>
        <button class="btn" id="dice_button_sw_d123" onclick="diceIncrement('sw_d123')">
          <img src="svg/v1/dice_sw_d123.svg" width="24" height="24" />
        </button>
        &#215;
        <input id="dice_input_sw_d123" type="number" class="dice_quantity" min="0" value="0"/>
      </td>
      </tr></table>
      <button id="dialog_submit_sw" onclick="ui_submit_dice('sw')"
        class="btn modal-close">
        Submit
      </button>
    </section>
    <section class="dice_section" id="fudge_dice_section">
      <a name="fudge"></a>
      <h1 id="fudge_dice_h1">FUDGE (FATE) Dice</h1>
      <table class="dice_input_table"><tr>
      <td>
        <button class="btn" id="dice_button_fudge_d6" onclick="diceIncrement('fudge_d6')">
          <img src="svg/v1/dice_fudge_d6.svg" width="24" height="24" />
        </button>
        &#215;
        <input id="dice_input_fudge_d6" type="number" class="dice_quantity" min="0" value="0"/>
      </td>
      </tr></table>
      <button id="dialog_submit_fudge" onclick="ui_submit_dice('fudge')"
        class="btn modal-close">
        Submit
      </button>
    </section>
    <section class="dice_section" id="special_dice_section">
      <a name="special"></a>
      <h1 id="special_dice_h1">Special Dice</h1>
      <table class="dice_input_table"><tr>
      <td id="dice_cell_dn">
        <script>
function alterFaces(el) {
  console.log(el.value)
  make_prototype('svg/v1/dice_dn.svg')
  .then(p => {
    facesTspan = p.querySelector('#tspan_num_faces')
    facesTspan.textContent = 'd' + parseInt(el.value)
    showTspan = p.querySelector('#tspan_numeric_value')
    showTspan.textContent = parseInt(el.value)

    temp = document.querySelector('#dn_prototype')
    while(temp.firstElementChild) {
      // Clear it out - prevent memory leaks
      temp.firstElementChild.remove()
    }
    temp.appendChild(p)

    svg_dn = document.querySelector('#svg_dn')
    svg_dn.style.display = 'block'

    useEl = document.querySelector('#svg_dn use')
    useEl.setAttribute('href', '#' + p.id)
  })
}
function loadPrototypeDN() {
  return alterFaces( document.querySelector('#dice_input_dn_num_faces'))
}
        </script>
        How many faces? <input
          id="dice_input_dn_num_faces" type="text" value="100" size="3"
          oninput="alterFaces(this)"
          max="999" min="2"
        />
        <button class="btn" id="dice_button_dn" onclick="diceIncrement('dn')">
          <template id="dn_prototype">
          </template>
          <svg style="" id="svg_dn" viewbox="0 0 100 100" width="24" height="24" >
            <use xlink:href="#dice_dn_object" />
          </svg>
        </button>
        &#215;
        <input id="dice_input_dn" type="number" class="dice_quantity" min="0" value="0"/>
      </td>

      <td>
        Enter single numbers, letters or emoji, separated by spaces. <input
          id="dice_input_dsymbol_faces" type="text" value="0 1 ✗ ✔ y n" size="3"
          pattern="^.( .)*$"
        />
        <button class="btn" id="dice_button_dsymbol" onclick="diceIncrement('dsymbol')">
          <img id="img_dice_dsymbol" src="svg/v1/dice_dsymbol.svg" width="24" height="24" />
        </button>
        &#215;
        <input id="dice_input_dsymbol" type="number" class="dice_quantity" min="0" value="0"/>
      </td>
      </tr></table>
      <button id="dialog_submit_special" onclick="ui_submit_dice('special')"
        class="btn modal-close">
        Submit
      </button>
    </section>
  </div>
  </div>

<!-- END DIALOG_DICE ====================================== END DIALOG_DICE -->


<!-- SVGFILE =========================================================== SVGFILE -->

  <div class="modal" id="dialog_svgfile">
    <script>

var svgfile_verbs = {
  'Object properties': {
    applicable: () => { return true },
    eventName: 'object_properties',
    handler: (evt) => {
      //console.log('svgfile hand', evt)
      ui_popup_properties(
        byId(evt.detail.elemId.substring('nest_'.length)),
        {'data-dialog-id': 'dialog_properties'}
      )
    }
  },
}

function ui_submit_svgfile(evt) {
  textarea = byId('svgfile_body')

  allowJS = byId('dialog_svgfile').querySelector(
    'input[name=allow_javascript]:checked'
  )
  if (allowJS.value !== 'yes') {
    newDoc = new DOMParser().parseFromString(textarea.value, 'image/svg+xml')
    defanged = domJSON.toJSON(newDoc.firstChild)
    newDoc = domJSON.toDOM(defanged)
    body = newDoc.firstChild.outerHTML
  } else {
    body = textarea.value
  }

  nest = _import_foreign_svg(body, '')
  //console.log('got nest', nest)
  add_fresh_svg(nest.node)
  svg_table.node.appendChild(nest.node)
  ui.hookup_ui(nest.node)
  init_with_namespaces(nest.node)
  ui.hookup_menu_actions(nest.node)

  ui.popdown_dialog('dialog_svgfile')
  //net_fire({ type: 'create', data: serialize(nest.node) })
  push_sync()
}

    </script>
    <button class="dialog_cancel btn modal-close"
      data-dialog-id="dialog_svgfile"
    >
      &#215;
    </button>
  <div class="modal-content">
      <p><b>What is an SVG?</b>
        Fundamentally, an SVG is just a simple text file that tells the
        computer how to draw an image using shapes, the same way HTML is
        just a text file that tells the computer how to render a web page.
        <a href="https://www.w3schools.com/graphics/svg_intro.asp">Find out
        more here.</a>
      </p>
      <p>
        You can create your drawings with Free programs like
        <a href="https">Inkscape</a>
        or websites like
        <a href="https://svg-edit.github.io/svgedit/editor/svg-editor.html">SVGEdit</a>
      </p>
      <label>
      <input name="allow_javascript" type="radio" checked value="yes" />
      <span>Allow JavaScript (JavaScript not usable by others in multiplayer)</span>
      </label>
      <br />
      <label>
      <input name="allow_javascript" type="radio" value="no" />
      <span>Safety mode</span>
      </label>
      <p>
    <textarea id="svgfile_body" cols="82" rows=5></textarea>
    <div class="load_explain">
    Copy and paste the contents from an SVG file into this
    text box.
    </div>
    <br />
    <button id="dialog_submit" onclick="ui_submit_svgfile(this)"
      class="btn modal-close">
      Create
    </button>
    <p>
    <i>Note:</i> Some great SVG files can be found at <a
      href="https://game-icons.net" target="_">game-icons.net</a> and <a
      href="https://thenounproject.com" target="_">Noun Project</a>.
  </div>
  </div>

<!-- END SVGFILE =================================================== END SVGFILE -->


<!-- RECT =========================================================== RECT -->

  <div class="modal" id="dialog_rect">
    <script>

var rect_verbs = {
  'Object properties': {
    applicable: () => { return true },
    eventName: 'object_properties',
    handler: (evt) => {
      //console.log('rect hand', evt)
      ui_popup_properties(
        byId(evt.detail.elemId.substring('nest_'.length)),
        {'data-dialog-id': 'dialog_properties'}
      )
    }
  },
}

function make_rect(attrs) {
  var rect = svg_table.rect()
  rect.attr(Object.assign({
    'data-app-class': 'rect',
    id: 'rect_' + base32.short_id(),
    rx: 0,
    ry: 0,
    width: 100,
    height: 50,
    fill: '#fff59d',
    stroke: 'black',
    'fill-opacity': 0.9,
    'stroke-opacity': 0.9,
    'stroke-width': 1,
  }, attrs))

  var nest = ui.make_nest({
    'id': 'nest_' + rect.attr('id'), // special ID
    'data-nest-for': 'rect',
    'width': rect.rbox().width,
    'height': rect.rbox().height,
  })

  nest.add(rect)
  nest.node.dataset.appNamespaces = 'rect_verbs'
  ui.hookup_ui(nest.node)
  ui.hookup_menu_actions(nest.node)
  return nest;
}

function ui_submit_rect(evt) {
  w = parseInt(byId('rect_input_width').value);
  h = parseInt(byId('rect_input_height').value);
  color = byId('rect_input_color').value;
  if (!w || !h || !color ) {
    return;
  }
  var nest = make_rect({
    width: w,
    height: h,
    fill: color,
  });
  ui.popdown_dialog('dialog_rect')
  //net_fire({ type: 'create', data: serialize(nest) })
  push_sync()
}

    </script>
    <button class="dialog_cancel btn modal-close"
      data-dialog-id="dialog_rect"
    >
      &#215;
    </button>
  <div class="modal-content">
    <label for="rect_input_width">Width</label>
    <input id="rect_input_width" type="text" value="100"/>
    <br />
    <label for="rect_input_height">Height</label>
    <input id="rect_input_height" type="text" value="50"/>
    <br />
    <label for="rect_input_color">Color
    <input id="rect_input_color" type="color" value="#ffff00" />
    </label>
    <br />
    <button id="dialog_submit" onclick="ui_submit_rect(this)"
      class="btn modal-close">
      Create
    </button>
  </div>
  </div>

<!-- END RECT =================================================== END RECT -->


<!-- TEXT =========================================================== TEXT -->

  <div class="modal" id="dialog_text">
    <script>

var text_verbs = {
  'Object properties': {
    applicable: () => { return true },
    eventName: 'object_properties',
    handler: (evt) => {
      id = evt.detail.elemId.substring('nest_'.length)
      el = byId(id)
      ui_popup_properties(
        el,
        {'data-dialog-id': 'dialog_properties'}
      )
    }
  },
}


function make_text(attrs, content) {
  var padding = 8
  var text = svg_table.plain('')
  var tspan = text.tspan(content)
  text.attr(Object.assign({
    'data-app-class': 'text',
    id: 'text_' + base32.short_id(),
    fill: '#000000',
    stroke: 'black',
    x: 0,
    y: 0,
    'stroke-opacity': 0,
    'font-weight': 'normal',
    'font-size': '12pt',
  }, attrs))
  var rbox = text.rbox()
  text.y(0)
  text.x(padding/2)

  var rect = svg_table.rect()
  rect.attr(Object.assign({
    id: 'rect_' + text.attr('id'), // special ID
    rx: 5,
    ry: 5,
    fill: '#ffffff',
    stroke: 'black',
    'fill-opacity': 0.5,
    'stroke-opacity': 0.5,
    'stroke-width': 1,
  }, {
    width: rbox.width + padding,
    height: rbox.height
  }))
  rect.addClass('text-rect')

  var nest = ui.make_nest({
    'id': 'nest_' + text.attr('id'), // special ID
    'data-nest-for': 'text',
    x: 0,
    y: 0,
    width: rect.width(),
    height: rect.height() * 2,
  })
  nest.addClass('draggable-group')
  rect.y(rect.y() + (rect.height()/2))
  nest.add(rect)
  text.y(text.y() + (rect.height()/2))
  nest.add(text)

  ui.hookup_ui(nest.node)
  nest.node.dataset.appNamespaces = 'text_verbs'
  ui.hookup_menu_actions(nest.node)
  return nest;
}

function ui_submit_text(evt) {
  c = byId('text_input_content').value;
  color = byId('text_input_color').value;
  if (!c || !color ) {
    return;
  }
  var text = make_text({ fill: color }, c);
  ui.popdown_dialog('dialog_text')
  //net_fire({ type: 'create', data: serialize(text) })
  push_sync()
}

    </script>
    <button class="dialog_cancel btn modal-close"
      data-dialog-id="dialog_text"
    >
      &#215;
    </button>
  <div class="modal-content">
    <label for="text_input_content">Content</label>
    <input id="text_input_content" type="text" value="" Placeholder="Hello World"/>
    <br />
    <label for="text_input_color">Color
    <input id="text_input_color" type="color" value="#ffff00"
    />
    </label>
    <br />
    <button id="dialog_submit" onclick="ui_submit_text(this)"
      class="btn modal-close">
      Create
    </button>
  </div>
  </div>

<!-- END TEXT =================================================== END TEXT -->


<!-- CIRCLE ========================================================CIRCLE -->

  <div class="modal" id="dialog_ellipse">
    <script>

var ellipse_verbs = {
  'Object properties': {
    applicable: () => { return true },
    eventName: 'object_properties',
    handler: (evt) => {
      //console.log('ellipse handler')
      ui_popup_properties(
        byId(evt.detail.elemId.substring('nest_'.length)),
        {'data-dialog-id': 'dialog_properties'}
      )
    }
  },
}

function make_ellipse(attrs) {
  var ellipse = svg_table.ellipse()
  ellipse.attr(Object.assign({
    'data-app-class': 'ellipse',
    id: 'ellipse_' + base32.short_id(),
    rx: 100,
    ry: 50,
    cx: 50,
    cy: 50,
    fill: '#fff59d',
    stroke: 'black',
    'fill-opacity': 0.9,
    'stroke-opacity': 0.9,
    'stroke-width': 1,
  }, attrs))

  var nest = ui.make_nest({
    'id': 'nest_' + ellipse.attr('id'), // special ID
    'data-nest-for': 'ellipse',
    'width': ellipse.rbox().width,
    'height': ellipse.rbox().height,
  })

  nest.add(ellipse)

  ui.hookup_ui(nest.node)
  nest.node.dataset.appNamespaces = 'ellipse_verbs'
  ui.hookup_menu_actions(nest.node)
  return nest;
}

function ui_submit_ellipse(evt) {
  w = parseInt(byId('ellipse_input_width').value);
  h = parseInt(byId('ellipse_input_height').value);
  color = byId('ellipse_input_color').value;
  if (!w || !h || !color ) {
    return;
  }
  var nest = make_ellipse({
    rx: w / 2,
    ry: h / 2,
    cx: w / 2,
    cy: h / 2,
    fill: color,
  });
  ui.popdown_dialog('dialog_ellipse')
  //net_fire({ type: 'create', data: serialize(nest) })
  push_sync()
}

    </script>
    <button class="dialog_cancel btn modal-close"
      data-dialog-id="dialog_ellipse"
    >
      &#215;
    </button>
  <div class="modal-content">
    <label for="ellipse_input_width">Width</label>
    <input id="ellipse_input_width" type="text" value="100"/>
    <br />
    <label for="ellipse_input_height">Height</label>
    <input id="ellipse_input_height" type="text" value="50"/>
    <br />
    <label for="ellipse_input_color">Color
    <input id="ellipse_input_color" type="color" value="#ffff00"
    />
    </label>
    <br />
    <button id="dialog_submit" onclick="ui_submit_ellipse(this)"
      class="btn modal-close">
      Create
    </button>
  </div>
  </div>

<!-- END CIRCLE =============================================== END CIRCLE -->


<!-- OTHER ======================================================= OTHER -->

  <div class="modal" id="dialog_other">
  <script>
function ui_submit_image(evt) {
  inputEl = byId('input_image_url')
  let url = inputEl.value
  if (!url) {
    alert('No URL!')
    return
  }
  nest = _import_foreign_svg(`
    <svg width="200" height="200"
    xmlns="http://www.w3.org/2000/svg"
    xmlns:xlink="http://www.w3.org/1999/xlink">
    <image href="${url}" height="200" width="200"/>
    </svg>
  `, '')
  add_fresh_svg(nest.node)
  svg_table.node.appendChild(nest.node)
  ui.hookup_ui(nest.node)
  ui.hookup_menu_actions(nest.node)
  ui.popdown_dialog('dialog_other')
  //net_fire({ type: 'create', data: serialize(nest) })
  push_sync()
}
  </script>
    <button class="dialog_cancel btn modal-close" data-dialog-id="dialog_other"
    > &#215; </button>
    <nav class="dialog_nav">
    <div class="nav-wrapper">
      <ul class="left">
        <li><a href="#drawing">Drawing</a></li>
        <li><a href="#dynamic_paper">Dynamic Paper</a></li>
      </ul>
    </div>
    </nav>
    <div class="modal-content">
    <section id="drawing_section">
      <a name="drawing"></a>
      <h1 id="drawing_h1">Drawing</h1>
      <button id="rect_button" class="btn btn-small modal-trigger modal-close"
        data-target="dialog_rect"
        data-dialog-id="dialog_rect">
        + Rectangle ▭
      </button>
      <button id="ellipse_button" class="btn btn-small modal-trigger modal-close"
        data-target="dialog_ellipse"
        data-dialog-id="dialog_ellipse">
        + Circle ⬭
      </button>
      <button id="text_button" class="btn btn-small modal-trigger modal-close"
        data-target="dialog_text"
        data-dialog-id="dialog_text">
        + Text ⌨
      </button>
      <p>
      <button id="svgfile_button" class="btn btn-small modal-trigger modal-close"
        data-target="dialog_svgfile"
        data-dialog-id="dialog_svgfile">
        + SVG File
      </button>
      <p>
      <label>
        Image URL
      <input
          id="input_image_url" type="text"
          placeholder="https://www.1kfa.com/assets/img/atfa_white_on_transparent.png"
          pattern="http.*"
      />
      </label>
      <button class="btn btn-small modal-close"
        onclick="ui_submit_image()">
        + Image
      </button>
      <i>Note:</i> Some great images can be found on <a
        href="https://en.wikipedia.org/wiki/Wikipedia:Featured_pictures">Wikipedia</a>
      <!--
      <button id="random_table_button" class="btn btn-small modal-trigger modal-close"
        data-target="dialog_random_table"
        data-dialog-id="dialog_random_table">
        + Random Table
      </button>
      -->
    </section>
    <section id="dynamic_paper_section">
      <a name="dynamic_paper"></a>
      <h1 id="dynamic_paper_h1">Dynamic Paper</h1>
      <button class="btn btn-small modal-close"
        onclick="add_object('svg/v1/paper_sum.svg')">
        + Sum
      </button>
      <button class="btn btn-small modal-close"
        onclick="add_object('svg/v1/paper_count.svg')">
        + Count
      </button>
      <button class="btn btn-small modal-close"
        onclick="add_object('svg/v1/paper_modifier.svg')">
        + Modifier
      </button>
      <button class="btn btn-small modal-close"
        onclick="add_object('svg/v1/paper_best.svg')">
        + Best-of
      </button>
      <button class="btn btn-small modal-close"
        onclick="add_object('svg/v1/paper_sorter.svg')">
        + Sorter
      </button>
    </section>
    </div>
  </div>

<!-- END OTHER =============================================== END OTHER -->

<!-- CARDS ======================================================= CARDS -->

  <div class="modal" id="dialog_cards">
  <script>
function ui_submit_card() {
  inputEl = byId('card_input_card_code')
  if (!inputEl.checkValidity()) {
    return
  }
  card_code = inputEl.value
  add_object('svg/v1/single_poker_card.svg',
    { 'serializedState': card_code },
  )
  inputEl.value = ''
  ui.popdown_dialog('dialog_cards')
}
  </script>
    <button class="dialog_cancel btn modal-close" data-dialog-id="dialog_cards"
    > &#215; </button>
    <div class="modal-content">
    <section id="decks_section">
      <a name="decks"></a>
      <h1 class="decks_h1">Decks</h1>
      <button class="btn btn-small modal-close"
        onclick="add_object('svg/v1/poker_deck_mobile.svg')">
        + Poker Deck
      </button>
      <button class="btn btn-small modal-close"
        onclick="add_object('svg/v1/tarot_deck.svg')">
        + Tarot Deck
      </button>
      <button class="btn btn-small modal-close"
        onclick="add_object('svg/v1/deckahedron_deck.svg')">
        + Deckahedron
      </button>
    </section>
    <section id="cards_section">
      <a name="single"></a>
      <h1 class="single_h1">Single card</h1>
      <style>
      #card_input_card_code:invalid {
        border: solid red;
      }
      </style>
      <label>
        Enter card "code", or blank for a random card.
        Each card is new and not from a deck, so repeats may happen.
      <input
          id="card_input_card_code" type="text" placeholder="3h" size="3"
          title="A rank-suit card code. Like 'Ac' for the Ace of Clubs"
          pattern="1?[0-9ajqkAJQK][hcdsHCDS]"
      />
      </label>
      <button id="dialog_submit_single_card" onclick="ui_submit_card()"
        class="btn">
        + Card
      </button>
    </section>
    </div>
  </div>

<!-- END CARDS =============================================== END CARDS -->

<!-- CLOCKS ======================================================= CLOCKS -->

  <div class="modal" id="dialog_clocks">
    <button class="dialog_cancel btn modal-close" data-dialog-id="dialog_clocks"
    > &#215; </button>
    <div class="modal-content">
    <section id="clocks_section">
      <button class="btn btn-small modal-close"
        onclick="add_object('svg/v1/clock_4.svg')">
        + 4-Clock
      </button>
      <button class="btn btn-small modal-close"
        onclick="add_object('svg/v1/clock_6.svg')">
        + 6-Clock
      </button>
      <button class="btn btn-small modal-close"
        onclick="add_object('svg/v1/clock_8.svg')">
        + 8-Clock
      </button>
      <button class="btn btn-small modal-close"
        onclick="add_object('svg/v1/clock_10.svg')">
        + 10-Clock
      </button>
      <button class="btn btn-small modal-close"
        onclick="add_object('svg/v1/clock_12.svg')">
        + 12-Clock
      </button>
    </section>
    </div>
  </div>

<!-- END CLOCKS =============================================== END CLOCKS -->


<!-- CONTRIBUTE =============================================== CONTRIBUTE -->
  <div class="modal" id="dialog_contribute">
   <b>Did Togetherness Table help you today?</b>
   <p>If you enjoy this tool, you can spread the love:</p>
    <nav class="dialog_nav" id="contribute_nav">
    <div class="nav-wrapper">
      <button class="dialog_cancel btn modal-close"
        data-dialog-id="dialog_contribute"
      >
        &#215;
      </button>
      <ul class="left">
        <li><a href="#surf">Surf the geekring</a></li>
        <li><a href="#recognize">Spread the word</a></li>
        <li><a href="#develop">Contribute time</a></li>
        <li><a href="#donate">Donate to related causes</a></li>
        <li><a href="#controls">Help with controls</a></li>
      </ul>
    </div>
    </nav>
  <div class="modal-content">
    <section>
      <a name="controls"></a>
      <h1 class="contribute_h1">Controls</h1>
        To roll dice, either click on them once, then press the Roll button,
        or double-click on them
      <p>
        To remove cards from a deck, double-click on the deck.
      </p>
      <p>
        To remove objects from a Dynamic Paper, double-click it.
      </p>
      <p>
        To resize a Dynamic Paper, double-click it, then drag the gray square
        handle in the lower corner.
      </p>
      <p>
        To select multiple dice, hold <b>Shift</b> and click on each one.
      </p>
      <p>
        To zoom in/out, hold <b>Ctrl</b> and roll your mouse wheel.
      </p>
    </section>
    <section>
      <a name="surf"></a>
      <h1 class="contribute_h1">Surf
      <a href="https://geekring.net">The Geek Ring</a></h1>
  <!-- Geekring widget #1 - simple links -->
    <a class="btn btn-large"
      href="http://geekring.net/site/8/previous">Previous</a>
    <a class="btn btn-large"
      href="http://geekring.net/site/8/random">Random site</a>
    <a class="btn btn-large"
      href="http://geekring.net/site/8/next">Next</a>

    </section>
    <section>
      <a name="recognize"></a>
      <h1 class="contribute_h1">Give some recognition</h1>
      <div class="contribute_explain">
      If you do the whole social media thing:
      <a href="https://twitter.com/home?status=Thanks be to @boardcrafting for
      hosting https://www.1kfa.com/table !">By tweeting a tweet</a> or
      <a href="https://mastodon.social/">tooting a toot</a>.
      <p>
      If you've got a Github account, you can
      <a href="https://github.com/sjbrown/1kfa">"star" this project</a>
      or
      <a href="https://github.com/sjbrown/1kfa">report an issue</a>
      </div>
    </section>
    <section>
      <a name="develop"></a>
      <h1 class="contribute_h1">Contribute to the codebase</h1>
      <div class="contribute_explain">
      Speaking of Github, you can
      <a href="https://github.com/sjbrown/1kfa">fork and contribute to this project</a>
      </div>
    </section>
    <section>
      <a name="donate"></a>
      <h1 class="contribute_h1">Donate</h1>
      <div class="contribute_explain">
      This is built on top of TogetherJS, a free, open-source project created by
      the Mozilla Foundation. They need money to continue making great software
      like this.
      <a href="https://donate.mozilla.org/en-US/">Donate to Mozilla here.</a>
      </div>
    </section>
  </div>
  </div>
<!-- /CONTRIBUTE ============================================== /CONTRIBUTE -->


<div id="hint_controls">
  <style>
#hint_controls {
  position: absolute;
  top: 0;
  right: 200px;
  display: none;
}
  </style>
  <script>
window.addEventListener('load', () => {
  if (localStorage['dismissHintControls'] !== 'yes') {
    document.querySelector('#hint_controls').style.display = 'block'
  }
})
function dismissHintControls() {
  localStorage['dismissHintControls'] = 'yes'
  document.querySelector('#hint_controls').style.display = 'none'
}
  </script>
  <button id="hint_controls_button" class="btn btn-small modal-trigger"
    data-target="dialog_contribute"
    data-dialog-id="dialog_contribute">
    Help with keyboard and mouse controls
  </button>
  <button id="hint_controls_dismiss" class="btn btn-small"
   onclick="dismissHintControls()"
  >
  &#215;
  </button>
</div>


  <menu type="context" id="gamemenu">
    <template id="template_menuitem">
      <menuitem label="X"
      ></menuitem>
    </template>
    <menuitem label="Delete marked objects"
     onclick="delete_marked(this)"
    ></menuitem>
  </menu>


<!-- =========================FOOTER==================== -->
<style>

#footer {
  flex-shrink: 0;
  display: flex;
  flex-direction: column;
  min-width: 80%;
  overflow: scroll;
  max-height: 100px;
}
@media screen and (max-width: 1200px) {
  #footer {
    min-width: 100%;
  }
}


.footerbar.inactive {
  animation: slide-out 0.5s forwards;
  visibility: collapse;
  padding: 0px 0px;
}

.footerbar {
  width: 100%;
  padding: 4px 10px;
  transition: background-color 2s;
  transition: transform 2s;
}

.graybg {
  background-color: #a0a0a0;
}

.bluebg {
  background-color: rgb(0, 149, 221);
}

.whitebg {
  background-color: #f0f0f0;
}

.footerbar h3 {
  display: inline;
}

</style>
  <div id="footer">
    <!-- =============SHARE URL BAR ==================== -->
    <div id="share_url_bar" class="inactive footerbar whitebg">
    <style>

     #share_url_bar td {
       padding: 0px;
       border-radius: 0px;
     }
     #share_url_bar tr {
       border: 0px;
     }
     #share_url_label {
       font-size: larger;
       margin-right: 40px;
     }
    </style>
      <table
      title="Share this URL with your friends and have them join you"
      >
      <tr>
      <td>
      <span id="share_url_label">Share URL:</span>
      </td>
      <td>
      <style>
      #share_url {
        font-family: monospace;
        display: inline-block;
        background-color: transparent;
        border: none;
        font-size: inherit;
        height: inherit;
        margin: inherit;

      }
      </style>
      <input id="share_url" value="" />
      </td>
      <td>
      <script>
      function copyURLToClipboard() {
        copyText = document.getElementById('share_url')
        /* Select the text field */
        copyText.select()
        copyText.setSelectionRange(0, 99999) /*For mobile devices*/
        document.execCommand("copy")
      }
      </script>
      <button id="share_url_copy_button" class="btn btn-small"
        onClick="copyURLToClipboard()"
      >Copy URL</button>
      </td>
      </tr>
      </table>
    </div>
    <!-- =================================DEBUG======================= -->
    <div id="debug_bar" class="footerbar inactive graybg debug_none">
    <script>
    window.addEventListener('load', () => {
      let q = new URLSearchParams(window.location.search)
      if (q.get('debug') === '1') {
        DEBUG = 1
        let bar = document.getElementById('debug_bar')
        bar.classList.remove('debug_none')
        bar.classList.remove('inactive')
      }
    })
    </script>
    <style>
    .debug_none {
      display: none;
    }
    </style>
        <pre id="debug_bar_log">
        </pre>
    </div>
  </div>

</body>
</html>

